let e=class ItemsWithSpells5e{static MODULE_ID="items-with-spells-5e";static SETTINGS={};static FLAGS={itemSpells:"item-spells",parentItem:"parent-item"};static TEMPLATES={spellsTab:`modules/${ItemsWithSpells5e.MODULE_ID}/templates/spells-tab.hbs`,overrides:`modules/${ItemsWithSpells5e.MODULE_ID}/templates/overrides-form.hbs`};static init(){ItemsWithSpells5e.preloadTemplates()}static preloadTemplates(){dnd5e.utils.registerHandlebarsHelpers(),loadTemplates(ItemsWithSpells5e.TEMPLATES)}static isIwsItem(e){return e.getFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.itemSpells)??null}static isIwsSpell(e){return ItemsWithSpells5e.getSpellParentId(e)}static getSpellParentId(e){return e.getFlag(ItemsWithSpells5e.MODULE_ID,ItemsWithSpells5e.FLAGS.parentItem)??null}static async getSpellParentItem(e,t=!1,s=!1){if(t&&!e.isEmbedded)return null;const i=ItemsWithSpells5e.getSpellParentId(e);if(!i)return null;const l=s??e.actor?.items??!1;if(t&&!l)return null;if(l){const e=i.split(".").pop();return l.get(e)??null}return await fromUuid(i)}static isIncludedItemType(e){let t=!1;try{t=!!game.settings.get(ItemsWithSpells5e.MODULE_ID,`isIncludedItemType${e.titleCase()}`)}catch{}return t}static isUsableItem(e){if(!1===e.system?.identified)return!1;if(foundry.utils.isNewerVersion(game.system.version,"3.1.99")){const t="required"===e.system.attunement;if(!e.system.attuned&&t)return!1}else{const t=CONFIG.DND5E.attunementTypes?.REQUIRED??1;if(e.system?.attunement===t)return!1}return!game.settings.get(ItemsWithSpells5e.MODULE_ID,"excludeUnequipped")||!1!==e.system.equipped}};class ItemsWithSpells5eActorSheet{static init(){const t=e.MODULE_ID,s=ItemsWithSpells5eActorSheet.prepareItemSpellbook;["Character","NPC"].forEach((e=>{libWrapper.register(t,`dnd5e.applications.actor.ActorSheet5e${e}.prototype._prepareSpellbook`,s,"WRAPPER")}))}static prepareItemSpellbook(t,s,i){const l=game.settings.get(e.MODULE_ID,"sortOrder")?20:-5,n=[],a=new Map;i.forEach((t=>{const s=e.getSpellParentId(t);if(s&&this.actor.items.some((e=>[e.id,e.uuid].includes(s)))){const e=s.split(".").pop();a.get(e)||a.set(e,[]),a.get(e).push(t)}else n.push(t)}));const r=t(s,n);return this.actor.items.filter((t=>{const s=t.getFlag(e.MODULE_ID,e.FLAGS.itemSpells)?.length;if(!s)return!1;return e.isIncludedItemType(t.type)})).forEach((t=>{const s=a.get(t.id);if(!s)return;if(!e.isUsableItem(t))return;const i=((e,t={},s=[])=>({order:l,label:e.name,usesSlots:!1,canCreate:!1,canPrepare:!1,spells:s,uses:t.value??"-",slots:t.max??"-",override:0,dataset:{"iws-item-id":e.id},prop:"item-"+e.id}))(t,t.system.uses,s);r.push(i)})),r.sort(((e,t)=>e.order-t.order||e.label-t.label)),r}}class ItemsWithSpells5eActor{static init(){Hooks.on("createItem",ItemsWithSpells5eActor.handleCreateItem),Hooks.on("deleteItem",ItemsWithSpells5eActor.handleDeleteItem)}static async handleDeleteItem(t,s,i){if(i!==game.user.id)return;if(!(t.parent instanceof Actor))return;if(["group","vehicle"].includes(t.parent.type))return;if(!(t.getFlag(e.MODULE_ID,e.FLAGS.itemSpells)??[]).length)return;const l=t.actor.items.reduce(((s,i)=>{const l=e.getSpellParentId(i);return[t.id,t.uuid].includes(l)&&s.push(i.id),s}),[]);if(!l.length)return;return s.itemsWithSpells5e?.alsoDeleteChildSpells??await Dialog.confirm({title:game.i18n.localize("IWS.MODULE_NAME"),content:game.i18n.localize("IWS.QUERY_ALSO_DELETE")})?t.actor.deleteEmbeddedDocuments("Item",l):void 0}static async handleCreateItem(t,s,i){if(i!==game.user.id)return;if(!(t.parent instanceof Actor))return;if(["group","vehicle"].includes(t.parent.type))return;if(!e.isIncludedItemType(t.type))return;const l=t.getFlag(e.MODULE_ID,e.FLAGS.itemSpells)??[];if(!l.length)return;const n=(await Promise.all(l.map((e=>ItemsWithSpells5eActor._createSpellData(t,e))))).filter((e=>e)),a=(await t.actor.createEmbeddedDocuments("Item",n)).map((e=>({uuid:e.uuid,id:e.id})));return t.setFlag(e.MODULE_ID,e.FLAGS.itemSpells,a)}static async _createSpellData(t,s){const i=await fromUuid(s.uuid);if(!i)return null;const l=s.changes?.system||{};l.attackBonus&&(l.ability="none",l.attackBonus=`${l.attackBonus||0} - @prof`);const n=l.uses?.max;if(n){const e=t.getRollData({deterministic:!0});l.uses.value=dnd5e.utils.simplifyBonus(n,e)}l.consume?.amount&&(l.consume.type="charges",l.consume.target=t.id);const a=game.items.fromCompendium(i),r={[`flags.${e.MODULE_ID}.${e.FLAGS.parentItem}`]:t.id,system:{...l,"preparation.mode":"atwill"}},m=i.flags["tidy5e-sheet"]?.section;return m&&(r["flags.tidy5e-sheet.section"]=null),foundry.utils.mergeObject(a,r)}}class ItemsWithSpells5eItemSpellOverrides extends FormApplication{constructor(e,t){const s=e.itemSpellFlagMap.get(t);super(s?.changes??{}),this.itemSpellId=t,this.itemWithSpellsItem=e,this.item=e.item,this.itemSpellItem=e.itemSpellItemMap.get(t)}get id(){return`${e.MODULE_ID}-${this.item.id}-${this.itemSpellItem.id}`}get title(){return`${this.item.name} - ${this.itemSpellItem.name}`}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["dnd5e","sheet","item","iws"],template:e.TEMPLATES.overrides,width:560,closeOnSubmit:!1,submitOnChange:!0,height:"auto"})}getData(){const e=this.item.system.uses||{};return{hasAttack:this.itemSpellItem.hasAttack,hasSave:this.itemSpellItem.hasSave,save:this.itemSpellItem.system.save,overrides:this.object,config:{limitedUsePeriods:CONFIG.DND5E.limitedUsePeriods,abilities:CONFIG.DND5E.abilities,spellLevels:CONFIG.DND5E.spellLevels,saveScaling:{spell:{label:"DND5E.Spellcasting"},...CONFIG.DND5E.abilities,flat:{label:"DND5E.Flat"}}},isFlatDC:"flat"===this.object?.system?.save?.scaling,spell:this.itemSpellItem,parentItem:{id:this.item.id,name:this.item.name,isEmbedded:this.item.isEmbedded,hasUses:this.item.hasLimitedUses&&e.per in CONFIG.DND5E.limitedUsePeriods&&e.max>0}}}async _updateObject(e,t){const s=foundry.utils.expandObject(t);await this.itemWithSpellsItem.updateItemSpellOverrides(this.itemSpellId,s.overrides),this.object=s.overrides,this.item.isEmbedded&&ui.notifications.warn("The existing spells on the parent actor will not be modified to reflect this change."),e instanceof SubmitEvent?this.close():this.render()}}class ItemsWithSpells5eItem{constructor(e){this.item=e,this._itemSpellFlagMap=null,this._itemSpellItems=null}get itemSpellFlagMap(){return null===this._itemSpellFlagMap?this._getItemSpellFlagMap():this._itemSpellFlagMap}get itemSpellList(){return this.item.getFlag(e.MODULE_ID,e.FLAGS.itemSpells)??[]}get itemSpellItemMap(){return null===this._itemSpellItems?this._getItemSpellItems():this._itemSpellItems}async refresh(){this._getItemSpellFlagMap(),await this._getItemSpellItems()}async _getChildItem({uuid:t,changes:s={}}){let i=await fromUuid(t);if(i||(i=((e,t)=>new Item.implementation({name:game.i18n.localize("IWS.MISSING_ITEM"),img:"icons/svg/hazard.svg",type:"spell",system:{description:{value:game.i18n.localize("IWS.MISSING_ITEM_DESCRIPTION")}},_id:e.split(".").pop()},{temporary:!0,parent:t}))(t,this.item.parent)),i.getFlag(e.MODULE_ID,e.FLAGS.parentItem)===this.item.uuid)return i;const l=foundry.utils.mergeObject(s,this._getFlagFixObject(i,t));foundry.utils.getProperty(s,"system.consume.amount")&&foundry.utils.mergeObject(l,{"system.consume.type":"charges","system.consume.target":this.item.id});const n=new Item.implementation(i.toObject(),{temporary:!0,keepId:!1,parent:this.item.parent});return await n.updateSource(l),n}async _getItemSpellItems(){const e=new Map;return await Promise.all(this.itemSpellList.map((async({uuid:t,changes:s})=>{const i=await this._getChildItem({uuid:t,changes:s});if(i)return e.set(i.id,i),i}))),this._itemSpellItems=e,e}_getItemSpellFlagMap(){const e=new Map;return this.itemSpellList.forEach((t=>{const s=t.uuid.split(".").pop();e.set(s,t)})),this._itemSpellFlagMap=e,e}_getFlagFixObject(t,s){const i=foundry.utils.isNewerVersion(game.version,"11.999")?"_stats.compendiumSource":"flags.core.sourceId",l={[i]:s,[`flags.${e.MODULE_ID}.${e.FLAGS.parentItem}`]:this.item.uuid,"system.preparation.mode":"atwill"},n=t.flags["tidy5e-sheet"]?.section;return n&&(l["flags.tidy5e-sheet.section"]=null),l}async addSpellToItem(t){let s=t;if(this.item.isEmbedded){const e=await fromUuid(s);if(!e)return void ui.notifications.error("Item data for",s,"not found");const i=this._getFlagFixObject(e,t),l=foundry.utils.mergeObject(e.toObject(),i),[n]=await this.item.actor.createEmbeddedDocuments("Item",[l]);s=n.uuid}const i=[...this.itemSpellList,{uuid:s}],l=`flags.${e.MODULE_ID}.${e.FLAGS.itemSpells}`;await this.item.update({[l]:i},{render:!1}),await this.refresh(),this.item.render(),this.item.actor&&this.item.actor.render()}async removeSpellFromItem(t,{alsoDeleteEmbeddedSpell:s}={}){const i=this.itemSpellItemMap.get(t),l=this.item.isEmbedded?i.uuid:await i.getFlag("core","sourceId"),n=this.itemSpellList.filter((({uuid:e})=>e!==l));if(this._itemSpellItems?.delete(t),this._itemSpellFlagMap?.delete(t),await this.item.setFlag(e.MODULE_ID,e.FLAGS.itemSpells,n),!this.item.isEmbedded)return;const a=fromUuidSync(l);if(!a)return;return s&&await Dialog.confirm({title:game.i18n.localize("IWS.MODULE_NAME"),content:game.i18n.localize("IWS.WARN_ALSO_DELETE")})?a.delete():a.unsetFlag(e.MODULE_ID,e.FLAGS.parentItem)}async updateItemSpellOverrides(t,s){const i=this.itemSpellFlagMap.get(t);i.changes=s,this.itemSpellFlagMap.set(t,i);const l=[...this.itemSpellFlagMap.values()];await this.item.update({[`flags.${e.MODULE_ID}.${e.FLAGS.itemSpells}`]:l},{render:!1}),await this.refresh(),ItemsWithSpells5eItemSheet.instances.forEach((e=>{e.itemWithSpellsItem===this&&(e._shouldOpenSpellsTab=!0)})),this.item.render()}static async getItemSpells(e,t=!1,s=!1){if("string"==typeof e&&(e=await fromUuid(e)),t&&!e.isEmbedded)return null;const i=new ItemsWithSpells5eItem(e);if(!i.itemSpellList.length)return null;const l=!!(s??t)&&e.actor?.items;if(t&&!l)return null;if(l){const t=new Map,s=[e.id??e._id,e.uuid];return l.forEach((e=>{const i=ItemsWithSpells5e.getSpellParentId(e);s.includes(i)&&t.set(e.id,e)})),t}return await i.itemSpellItemMap}}class ItemsWithSpells5eItemSheet{_shouldOpenSpellsTab=!1;constructor(e,[t]){this.app=e,this.item=e.item,this.sheetHtml=t,this.itemWithSpellsItem=new ItemsWithSpells5eItem(this.item)}static instances=new Map;static init(){Hooks.on("renderItemSheet",((t,s)=>{if(game.modules.get("tidy5e-sheet")?.api?.isTidy5eItemSheet(t)||!e.isIncludedItemType(t.item.type))return;const i=ItemsWithSpells5eItemSheet.instances.get(t.appId);if(i)return i.renderLite(),void(i._shouldOpenSpellsTab&&(t._tabs?.[0]?.activate?.("spells"),i._shouldOpenSpellsTab=!1));const l=new ItemsWithSpells5eItemSheet(t,s);return ItemsWithSpells5eItemSheet.instances.set(t.appId,l),l.renderLite()})),Hooks.on("closeItemSheet",(async e=>{if(ItemsWithSpells5eItemSheet.instances.get(e.appId))return ItemsWithSpells5eItemSheet.instances.delete(e.appId)})),Hooks.once("tidy5e-sheet.ready",(t=>{const s=new t.models.HtmlTab({title:game.i18n.localize("TYPES.Item.spellPl"),tabId:"items-with-spells-5e",html:"",enabled:t=>e.isIncludedItemType(t.item.type),onRender(t){if(!e.isIncludedItemType(t.data.item.type))return;let s=t.app,i=[t.element];const l=ItemsWithSpells5eItemSheet.instances.get(s.appId);if(l)l.renderHeavy(t.tabContentsElement);else{const e=new ItemsWithSpells5eItemSheet(s,i);ItemsWithSpells5eItemSheet.instances.set(s.appId,e),e.renderHeavy(t.tabContentsElement)}}});t.registerItemTab(s,{autoHeight:!0})}))}async _renderSpellsList(){const t=[...(await this.itemWithSpellsItem.itemSpellItemMap).values()];return renderTemplate(e.TEMPLATES.spellsTab,{itemSpells:t,config:{limitedUsePeriods:CONFIG.DND5E.limitedUsePeriods,abilities:CONFIG.DND5E.abilities},isEmbedded:this.item.isEmbedded,isOwner:this.item.isOwner,concealDetails:!game.user.isGM&&!1===this.item.system.identified})}async _dragEnd(e){if(!this.app.isEditable)return;const t=TextEditor.getDragEventData(e);if("Item"!==t.type)return;return"spell"===fromUuidSync(t.uuid).type?(this._shouldOpenSpellsTab=!0,this.itemWithSpellsItem.addSpellToItem(t.uuid)):void 0}async _handleItemClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId,s=this.itemWithSpellsItem.itemSpellItemMap.get(t);s?.sheet.render(!0,{editable:!!s.isOwner&&!!s.isEmbedded})}async _handleItemDeleteClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId;return this._shouldOpenSpellsTab=!0,this.itemWithSpellsItem.removeSpellFromItem(t)}async _handleItemDestroyClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId;return this._shouldOpenSpellsTab=!0,this.itemWithSpellsItem.removeSpellFromItem(t,{alsoDeleteEmbeddedSpell:!0})}async _handleItemEditClick(e){const t=e.currentTarget.closest("[data-item-id]").dataset.itemId,s=this.itemWithSpellsItem.itemSpellItemMap.get(t);return s.isEmbedded?s.sheet.render(!0):new ItemsWithSpells5eItemSpellOverrides(this.itemWithSpellsItem,t).render(!0)}renderLite(){const e=document.createElement("DIV");e.innerHTML=`<a class="item" data-tab="spells">${game.i18n.localize("TYPES.Item.spellPl")}</a>`;const t=this.sheetHtml.querySelector(".tabs[data-group=primary]");if(!t)return;t.appendChild(e.firstElementChild);const s=this.sheetHtml.querySelector(".sheet-body");e.innerHTML="<div class='tab spells flexcol' data-group='primary' data-tab='spells'></div>";const i=e.firstElementChild;s.appendChild(i),this.renderHeavy(i)}async renderHeavy(e){const t=document.createElement("DIV");t.innerHTML=await this._renderSpellsList();const s=t.firstElementChild;e.appendChild(s),s.querySelectorAll(".item-name").forEach((e=>e.addEventListener("click",this._handleItemClick.bind(this)))),s.querySelectorAll(".item-delete").forEach((e=>e.addEventListener("click",this._handleItemDeleteClick.bind(this)))),s.querySelectorAll(".item-destroy").forEach((e=>e.addEventListener("click",this._handleItemDestroyClick.bind(this)))),s.querySelectorAll(".configure-overrides").forEach((e=>e.addEventListener("click",this._handleItemEditClick.bind(this))));const i={dragSelector:".item",dropSelector:".items-with-spells-tab",permissions:{drop:()=>this.app.isEditable&&!this.item.isEmbedded},callbacks:{drop:this._dragEnd}};this.app.element[0].querySelector(i.dropSelector).addEventListener("drop",i.callbacks.drop.bind(this))}}const t=["class","subclass","background","race","lineage","spell","base","container","backpack"];class IWS_TypeSettings extends FormApplication{get id(){return`${e.MODULE_ID}-item-type-exclusion-menu`}get title(){return game.i18n.localize("IWS.SETTINGS.ITEM_EXCLUSION.TITLE")}get template(){return"modules/items-with-spells-5e/templates/settingsMenu.hbs"}async getData(){const s=Item.TYPES.filter((e=>!t.includes(e))),i=await super.getData();i.types=[];for(const t of s){const s=t.titleCase();i.types.push({checked:game.settings.get(e.MODULE_ID,`isIncludedItemType${s}`),value:t,label:s})}return i}async _updateObject(t,s){Object.entries(s).forEach((([t,s])=>{game.settings.set(e.MODULE_ID,`isIncludedItemType${t.titleCase()}`,s)}))}}let s=null;class ItemsWithSpells5eExtendHUD{static init(){game.modules.get("token-action-hud-core")?.active&&game.modules.get("token-action-hud-dnd5e")?.active&&foundry.utils.isNewerVersion(game.modules.get("token-action-hud-dnd5e")?.version,"1.5.6")&&(Hooks.once("tokenActionHudCoreRegisterDefaults",(async t=>{const s="Items with Spells",i=t.layout.find((e=>"spells"===e.id)),l={id:e.MODULE_ID,name:s,listName:`Group: ${s}`,type:"system",nestId:`spells_${e.MODULE_ID}`};t.groups.push(l),i.groups.unshift(l)})),Hooks.once("tokenActionHudCoreApiReady",(async i=>{s=class ItemsWithSpellsActionHandlerExtender extends i.api.ActionHandlerExtender{constructor(e){super(),this.actionHandler=e,this.actor=null,this.iwsExcludeUnequipped=null}async extendActionHandler(){if(this.actor=this.actionHandler.actor,!this.actor)return;this.iwsExcludeUnequipped=game.settings.get(e.MODULE_ID,"excludeUnequipped");const s={id:e.MODULE_ID,type:"system"};for(const[l,n]of this.actor.items.entries()){if(t.includes(n.type))continue;if(!e.isUsableItem(n))continue;const l=await ItemsWithSpells5eItem.getItemSpells(n,!0,this.actor.items);if(!l)continue;const a={},r=n?.system?.uses;if(r?.per&&(r.value>0||r.max>0)){const e=i.api.Utils.i18n("DND5E.per"),t=CONFIG.DND5E.limitedUsePeriods[r.per]?.label??r.per,s="charges"===r.per?t:`${e} ${t}`;a.text=`${r.value??"0"}${r.max>0?`/${r.max}`:""}`,a.title=`${n.name}: ${a.text} ${s}`}const m={id:`${e.MODULE_ID}_${n.id}`,name:n.name,type:"system-derived",info1:a,defaultSelected:!0,settings:{sort:!0}};this.actionHandler.addGroup(m,s);const o={groupData:m,actionData:l,actionType:"spell"};await this.actionHandler.buildActions(o)}}}})),Hooks.once("tokenActionHudCoreAddActionHandlerExtenders",(async e=>{e.addActionHandlerExtender(new s(e))})))}}Hooks.once("setup",(function _registerSettings(){const s=Item.TYPES.filter((e=>!t.includes(e)));for(const t of s)game.settings.register(e.MODULE_ID,`isIncludedItemType${t.titleCase()}`,{scope:"world",config:!1,type:Boolean,default:!0,requiresReload:!0});game.settings.register(e.MODULE_ID,"sortOrder",{name:"IWS.SETTINGS.SORT_ORDER.NAME",hint:"IWS.SETTINGS.SORT_ORDER.HINT",scope:"world",config:!0,type:Boolean,default:!1,requiresReload:!1}),game.settings.registerMenu(e.MODULE_ID,"itemTypeExclusion",{name:"IWS.SETTINGS.ITEM_EXCLUSION.NAME",hint:"IWS.SETTINGS.ITEM_EXCLUSION.HINT",scope:"world",config:!0,type:IWS_TypeSettings,label:"IWS.SETTINGS.ITEM_EXCLUSION.NAME",restricted:!0}),game.settings.register(e.MODULE_ID,"excludeUnequipped",{name:"IWS.SETTINGS.EXCLUDE_UNEQUIPPED.NAME",hint:"IWS.SETTINGS.EXCLUDE_UNEQUIPPED.HINT",scope:"world",config:!0,type:Boolean,default:!0,requiresReload:!1})})),Hooks.once("init",ItemsWithSpells5eActor.init),Hooks.once("init",ItemsWithSpells5eActorSheet.init),Hooks.once("init",e.init),Hooks.once("init",ItemsWithSpells5eItemSheet.init),Hooks.once("init",ItemsWithSpells5eExtendHUD.init),Hooks.once("ready",(async()=>{game.modules.get(e.MODULE_ID).api={isIwsItem:e.isIwsItem,isIwsSpell:e.isIwsSpell,getItemSpells:ItemsWithSpells5eItem.getItemSpells,getSpellParentId:e.getSpellParentId,getSpellParentItem:e.getSpellParentItem,isIncludedItemType:e.isIncludedItemType,isUsableItem:e.isUsableItem}}));export{e as ItemsWithSpells5e,ItemsWithSpells5eActor,ItemsWithSpells5eActorSheet,ItemsWithSpells5eExtendHUD,ItemsWithSpells5eItem,ItemsWithSpells5eItemSheet,ItemsWithSpells5eItemSpellOverrides};
//# sourceMappingURL=items-with-spells-5e.min.js.map
