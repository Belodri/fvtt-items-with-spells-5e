{"version":3,"file":"items-with-spells-5e.min.js","sources":["classes/defaults.js","classes/actor-sheet.js","classes/actor.js","classes/item-spell-overrides.js","classes/item.js","classes/item-sheet.js","classes/settings.mjs","extensions/token-action-hud-dnd5e.js","init.js"],"sourcesContent":["export class ItemsWithSpells5e {\n  static MODULE_ID = 'items-with-spells-5e';\n  static SETTINGS = {};\n  static FLAGS = {\n    itemSpells: 'item-spells',\n    parentItem: 'parent-item',\n    knownUuid: 'original-uuid'\n  };\n  static TEMPLATES = {\n    spellsTabNew: `modules/${ItemsWithSpells5e.MODULE_ID}/templates/spells-tab-new.hbs`,\n    spellsTab: `modules/${ItemsWithSpells5e.MODULE_ID}/templates/spells-tab.hbs`,\n    overrides: `modules/${ItemsWithSpells5e.MODULE_ID}/templates/overrides-form.hbs`\n  };\n  static VERSIONS = {\n    get DnD5e_v4() { return foundry.utils.isNewerVersion(game.system.version, '4'); }\n  };\n\n  static init() {\n    ItemsWithSpells5e.preloadTemplates();\n  }\n\n  static preloadTemplates() {\n    dnd5e.utils.registerHandlebarsHelpers();\n    loadTemplates(ItemsWithSpells5e.TEMPLATES);\n  }\n\n  /**\n   * Test if an item is an items-with-spells-5e item\n   * @public\n   * @param {Item5e[]} item The item to get the attached spells from\n   * @returns the object with the spells\n   */\n  static isIwsItem(item) {\n    if (typeof item === 'string') item = fromUuidSync(item);\n    const itemSpells = item?.getFlag(ItemsWithSpells5e.MODULE_ID, ItemsWithSpells5e.FLAGS.itemSpells) ?? [];\n    return itemSpells.length ? itemSpells : null;\n  }\n\n  /**\n   * Test if a spell has a parent item by seeing if a parent id is set\n   * @public\n   * @param {Item5e[]} spell The spell with a parent item\n   * @returns the parent item id or `null` if no parent item is found\n   * `isIwsSpell` exposed in the api as alias for this\n   */\n  static getSpellParentId(spell) {\n    if (typeof spell === 'string') spell = fromUuidSync(spell);\n    return spell?.getFlag(ItemsWithSpells5e.MODULE_ID, ItemsWithSpells5e.FLAGS.parentItem) ?? null;\n  }\n\n  /**\n   * Get the parent item of a spell on the same actor\n   * @public\n   * @param {Item5e[]} spell The spell to get the parent item of\n   * @param {boolean} embeddedOnly Only return the item if owned by an actor\n   * @param {Map} providedItems Only return spells included in these items (e.g. pass actor.items)\n   * @returns the parent item or `null` if spell has no parent or parent is not owned by the same actor\n   */\n  static async getSpellParentItem(spell, embeddedOnly = false, providedItems = false) {\n    if (typeof spell === 'string') spell = await fromUuid(spell);\n    if (embeddedOnly && !spell?.isEmbedded) return null;\n    const parentId = ItemsWithSpells5e.getSpellParentId(spell);\n    if (!parentId) return null;\n    const items = providedItems ?? spell?.actor?.items ?? false;\n    if (embeddedOnly && !items) {\n      return null;\n    } else if (items) {\n      const parentIdLast = parentId.split('.').pop();\n      return items.get(parentIdLast) ?? null;\n    } else {\n      return await fromUuid(parentId);\n    }\n  }\n\n  /**\n   * Test if a type of item is enabled to have the spells tab from items-with-spells-5e\n   * @public\n   * @param {string} itemType The spell with a parent item\n   * @returns {boolean} true if spells tab should be visible\n   */\n  static isIncludedItemType(itemType) {\n    let include = false;\n    try {\n      include = !!game.settings.get(\n        ItemsWithSpells5e.MODULE_ID,\n        `isIncludedItemType${itemType.titleCase()}`\n      );\n    } catch {}\n    return include;\n  }\n\n  /**\n   * Test if the spells of an item should be shown (item is attuned, equipped, identified)\n   * @public\n   * @param {Item5e[]} item The parent item of the spell(s)\n   * @returns {boolean} true if item should be shown\n   */\n  static isUsableItem(item) {\n    if (typeof item === 'string') item = fromUuidSync(item);\n    // Unusable if item is not identified\n    if (item?.system?.identified === false) return false;\n    // Unusable if item is not equipped and setting set to exclude based unequipped\n    const iwsExcludeUnequipped = game.settings.get(ItemsWithSpells5e.MODULE_ID, \"excludeUnequipped\");\n    if (iwsExcludeUnequipped && item?.system.equipped === false) return false;\n    // Unusable if item is not attuned (but still show to GM)\n    if (!game.user.isGM) {\n      if (foundry.utils.isNewerVersion(game.system.version, \"3.1.99\")) {\n        const attunementRequired = item?.system?.attunement === \"required\";\n        if (attunementRequired && !item?.system?.attuned) return false;\n      } else {\n        const attunementRequired = CONFIG.DND5E.attunementTypes?.REQUIRED ?? 1;\n        if (item?.system?.attunement === attunementRequired) return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * Update the flags of an item with spells from DnD5e v3.x to v4.x\n   * @public\n   * @param {Item5e} item The item with the item with spells flags\n   * @returns {Item5e} the item with fixed flags\n   */\n  static async updateFlagsToV4(item) {\n    const itemSpellList = ItemsWithSpells5e.isIwsItem(item);\n    const oldType = itemSpellList?.some(s => s.changes);\n\n    if (oldType) {\n      const newItemSpells = itemSpellList.map(s => {\n        if (s.changes) {\n          s.overrides = ItemsWithSpells5e.updateChangesToV4(s.changes);\n          delete s.changes;\n        }\n        return s;\n      });\n      await item.update({[`flags.${ItemsWithSpells5e.MODULE_ID}.${ItemsWithSpells5e.FLAGS.itemSpells}`]: newItemSpells}, {render: false});\n    }\n\n    return item;\n  }\n\n  /**\n   * Update the old (DnD5e v3.x) changes object to the new overrides object (DnD5e v4.x)\n   * @public\n   * @param {object} changes The changes object stored in the IWS flag\n   */\n  static updateChangesToV4(changes) {\n    changes = foundry.utils.expandObject(changes);\n    const overrides = {};\n\n    // Limited inherit uses\n    if (changes.system?.uses?.max) {\n      overrides['uses.max'] = changes.system.uses.max\n    }\n    if (changes.system?.uses?.per) {\n      // system.uses.per \"charges\" option no longer exist (change to no recovery)\n      if (changes.system.uses.per === \"charges\") changes.system.uses.per = \"\";\n      overrides['uses.recovery'] = changes.system.uses.per;\n    }\n\n    // Consume charges from parent item\n    if (changes.system?.consume?.amount) {\n      overrides['consumption.value'] = changes.system.consume.amount;\n    }\n    if (changes.system?.consume?.scale) {\n      overrides['consumption.scaling'] = changes.system.consume.scale;\n    }\n\n    // Save\n    if (changes.system?.save?.scaling) {\n      switch(changes.system.save.scaling) {\n        case \"spell\":\n          // \"spell\" option is now \"spellcasting\"\n          changes.system.save.scaling = \"spellcasting\";\n          break;\n        case \"flat\":\n          // \"flat\" option is now \"\"\n          changes.system.save.scaling = \"\";\n          break;\n      }\n      overrides['saveActivity.calculation'] = changes.system.save.scaling;\n    }\n    if (changes.system?.save?.dc) {\n      overrides['saveActivity.formula'] = changes.system.save.dc;\n    }\n\n    // Attack\n    if (changes.system?.attack?.bonus || changes.system?.attackBonus) {\n      overrides['attackActivity.bonus'] = changes.system?.attack?.bonus ?? changes.system?.attackBonus;\n      overrides['attackActivity.flat'] = true;\n    }\n\n    return foundry.utils.expandObject(overrides);\n  }\n\n  /**\n   * Create an object that can be used to update a spell's data\n   * @public\n   * @param {Item5e} parentItem The item that owns the spell\n   * @param {Item5e} spell      The spell object to merge the overrides unto\n   * @param {object} overrides  The overrides object stored in the IWS flag\n   */\n  static createUpdateObject(parentItem, spell, overrides = {}) {\n    /*-- Create the update object --*/\n    // Starting with some defaults that we need to always set\n    const update = {\n      // a flag to point to the parentItem's ID\n      [`flags.${ItemsWithSpells5e.MODULE_ID}.${ItemsWithSpells5e.FLAGS.parentItem}`]: parentItem.id,\n      // preparation mode to 'atwill'\n      'system.preparation.mode': 'atwill',\n      // empty the spent uses\n      'system.uses.spent': null\n    };\n\n    // Make sure this doesn't have anything set for its Tidy 5e section\n    const tidy5eSectionFlag = spell.flags['tidy5e-sheet']?.section;\n    if (tidy5eSectionFlag) {\n      update['flags.tidy5e-sheet.section'] = null;\n    }\n\n    /*-- Convert the overrides object into a useable update object --*/\n    // Limited inherit uses\n    if (overrides.uses?.max) {\n      update['system.uses.max'] = overrides.uses.max;\n      if (overrides.uses.recovery) {\n        update['system.uses.recovery'] = [{ period: overrides.uses.recovery }];\n      } else {\n        update['system.uses.recovery'] = null;\n      }\n    }\n\n    // Create object for the charges consumed from parent item\n    const consumptionTargets = !overrides.consumption?.value ? false : [{\n      type: \"itemUses\",\n      value: overrides.consumption.value,\n      target: parentItem.id,\n      scaling: { \"mode\": overrides.consumption.scaling ? \"amount\" : \"\" }\n    }];\n\n    // Loop over all activities\n    for (const activity of spell.system.activities.values()) {\n      const actId = activity.id;\n\n      // Disable using a spell slot on cast\n      update[`system.activities.${actId}.consumption.spellSlot`] = false;\n\n      // Set charges consumed from parent item\n      if (consumptionTargets) {\n        update[`system.activities.${actId}.consumption.targets`] = consumptionTargets;\n      }\n\n      // Set save\n      if (activity.type === 'save' && overrides.saveActivity && overrides.saveActivity?.calculation !== 'noOverride') {\n        update[`system.activities.${actId}.save.dc.calculation`] = overrides.saveActivity.calculation;\n        if (overrides.saveActivity.calculation === '' && overrides.saveActivity?.formula) {\n          update[`system.activities.${actId}.save.dc.formula`] = overrides.saveActivity.formula;\n        }\n      }\n\n      // Set attack\n      if (activity.type === 'attack' && overrides.attackActivity) {\n        if (overrides.attackActivity.ability !== 'noOverride') {\n          update[`system.activities.${actId}.attack.ability`] = overrides.attackActivity.ability;\n        }\n        if (overrides.attackActivity.bonus) {\n          update[`system.activities.${actId}.attack.bonus`] = overrides.attackActivity.bonus;\n        }\n        if (overrides.attackActivity.flat) {\n          update[`system.activities.${actId}.attack.flat`] = overrides.attackActivity.flat;\n        }\n      }\n    }\n\n    return update;\n  }\n}","import {ItemsWithSpells5e as IWS} from './defaults.js';\n\n/* A class made to make managing the operations for an Actor. */\nexport class ItemsWithSpells5eActorSheet {\n  /* Set up the Actor Sheet Patch */\n  static init() {\n    const id = IWS.MODULE_ID;\n    const fn = ItemsWithSpells5eActorSheet.prepareItemSpellbook;\n    [\"Character\", \"NPC\"].forEach(a => {\n      libWrapper.register(id, `dnd5e.applications.actor.ActorSheet5e${a}.prototype._prepareSpellbook`, fn, \"WRAPPER\");\n    });\n  }\n\n  /**\n   * Filter iws spells into their own sections, removing them from standard sections.\n   * @param {Function} wrapped      A wrapping function.\n   * @param {object} data           The sheet data. **will be mutated**\n   * @param {Item5e[]} spells       The actor's spells.\n   * @returns {object}              The spellbook data.\n   */\n  static prepareItemSpellbook(wrapped, data, spells) {\n    const order = game.settings.get(IWS.MODULE_ID, \"sortOrder\") ? 20 : -5;\n    const createSection = (iws, uses = {}, spells = []) => {\n      return {\n        order: order,\n        label: iws.name,\n        usesSlots: false,\n        canCreate: false,\n        canPrepare: false,\n        spells,\n        uses: uses.value ?? \"-\",\n        slots: uses.max ?? \"-\",\n        override: 0,\n        dataset: {\"iws-item-id\": iws.id},\n        prop: \"item-\"+iws.id\n      };\n    };\n\n    // iterate through spells and put them in respective maps\n    const nonItemSpells = [];\n    const spellsPerItem = new Map();\n    spells.forEach((spell) => {\n      const parentId = IWS.getSpellParentId(spell);\n      if ( parentId && this.actor.items.some(item => [item.id, item.uuid].includes(parentId)) ) {\n        const parentIdLast = parentId.split('.').pop();\n        if (!spellsPerItem.get(parentIdLast)) spellsPerItem.set(parentIdLast, []);\n        spellsPerItem.get(parentIdLast).push(spell);\n      } else {\n        nonItemSpells.push(spell);\n      }\n    });\n\n    const spellbook = wrapped(data, nonItemSpells);\n\n    // get all the items with spells on this actor\n    const itemsWithSpells = this.actor.items.filter(item => {\n      const fl = IWS.isIwsItem(item);\n      if (!fl) return false;\n      const include = IWS.isIncludedItemType(item.type);\n      return include;\n    });\n\n    // create a new spellbook section for each item with spells attached\n    itemsWithSpells.forEach((iws) => {\n      const iwsSpells = spellsPerItem.get(iws.id);\n      if (!iwsSpells) return;\n      const iwsUsable = IWS.isUsableItem(iws);\n      if (!iwsUsable) return;\n      const section = createSection(iws, iws.system.uses, iwsSpells);\n      spellbook.push(section);\n    });\n\n    spellbook.sort((a, b) => (a.order - b.order) || (a.label - b.label));\n    return spellbook;\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\n\n/**\n * A class made to make managing the operations for an Actor.\n */\nexport class ItemsWithSpells5eActor {\n  /* Set up the create/delete Item hooks. */\n  static init() {\n    Hooks.on('createItem', ItemsWithSpells5eActor.handleCreateItem);\n    Hooks.on('deleteItem', ItemsWithSpells5eActor.handleDeleteItem);\n  }\n\n  /**\n   * When an item is deleted from an actor, find any of its child spells and prompt for those to be deleted.\n   * @param {Item5e} itemDeleted            The parent item that was deleted.\n   * @param {object} options                Deletion options.\n   * @param {string} userId                 The id of the user who performed the deletion.\n   * @returns {Promise<Item5e[]|void>}      The deleted spells.\n   */\n  static async handleDeleteItem(itemDeleted, options, userId) {\n    if (userId !== game.user.id) return;\n    if (!(itemDeleted.parent instanceof Actor)) return;\n    if ([\"group\", \"vehicle\"].includes(itemDeleted.parent.type)) return;\n\n    const ids = IWS.isIwsItem(itemDeleted);\n    if (!ids) return;\n\n    const spellIds = itemDeleted.actor.items.reduce((acc, item) => {\n      const flag = IWS.getSpellParentId(item);\n      if ([itemDeleted.id, itemDeleted.uuid].includes(flag)) acc.push(item.id);// check uuid, too, for backwards compat.\n      return acc;\n    }, []);\n\n    if (!spellIds.length) return;\n\n    // Ask the player to confirm spell deletion, unless the option for this is set, or unless the item is unidentified and the player doesn't know spells are attached (always ask for GM)\n    const optionOverride = options.itemsWithSpells5e?.alsoDeleteChildSpells;\n    const autoConfirm = !game.user.isGM && itemDeleted.system?.identified === false;\n    const confirm = optionOverride ?? autoConfirm ? true : await Dialog.confirm({\n      title: game.i18n.localize(\"IWS.MODULE_NAME\"),\n      content: game.i18n.localize(\"IWS.DIALOG.AlsoDeleteSpell\")\n    });\n    if (confirm) return itemDeleted.actor.deleteEmbeddedDocuments(\"Item\", spellIds);\n  }\n\n  /**\n   * When an item is created on an actor, if it has any spells to add, create those, and save\n   * a reference to their uuids and ids in the parent item within `flags.<module>.item-spells`.\n   * Each added spell also gets `flags.<module>.parent-item` being the parent item's id.\n   * @param {Item5e} itemCreated      The item with spells that was created.\n   * @param {object} options          Creation options.\n   * @param {string} userId           The id of the user creating the item.\n   * @returns {Promise<Item5e>}       The parent item updated with new flag data.\n   */\n  static async handleCreateItem(itemCreated, options, userId) {\n    if (userId !== game.user.id) return;\n    if (!(itemCreated.parent instanceof Actor)) return;\n    if ([\"group\", \"vehicle\"].includes(itemCreated.parent.type)) return;\n\n    // Bail out from creating the spells if the parent item is not valid.\n    const include = IWS.isIncludedItemType(itemCreated.type);\n    if (!include) return;\n\n    // Update flag schema to DnD5e v4.x\n    itemCreated = await IWS.updateFlagsToV4(itemCreated);\n\n    // Get array of objects with uuids of spells to create.\n    const spellUuids = IWS.isIwsItem(itemCreated);\n    if (!spellUuids) return;\n\n    // Create the spells from this item.\n    const spells = await Promise.all(spellUuids.map(d => ItemsWithSpells5eActor._createSpellData(itemCreated, d)));\n\n    // While filtering spells, create array with override objects, matching spellData index\n    const overridesData = [];\n    const spellData = spells.filter((s, idx) => s ? overridesData.push(spellUuids[idx]?.overrides) : false);\n\n    // Add the spells to the actor\n    const spellsCreated = await itemCreated.actor.createEmbeddedDocuments(\"Item\", spellData);\n\n    // Keep the overrides setting for each spell in case the item is ever put back into the sidebar\n    const ids = spellsCreated.map((s, idx) => ({uuid: s.uuid, id: s.id, overrides: overridesData[idx] }) );\n    return itemCreated.setFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells, ids);\n  }\n\n  /**\n   * Create the data for a spell with attack bonus, limited uses, references, and overrides.\n   * @param {Item5e} parentItem     The item that has spells.\n   * @param {object} data           Object with uuid and overrides.\n   * @returns {Promise<object>}     The item data for creation of a spell.\n   */\n  static async _createSpellData(parentItem, data) {\n    const spell = await fromUuid(data.uuid);\n    if (!spell) return null;\n\n    // Turn the overrides into an update object that can be merged\n    const update = IWS.createUpdateObject(parentItem, spell, data.overrides);\n\n    // Get a 'clean' implementation of the spell\n    const spellData = game.items.fromCompendium(spell);\n\n    return foundry.utils.mergeObject(spellData, update);\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\n\n/**\n * The form to control Item Spell overrides (e.g. for consumption logic)\n */\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\nexport class ItemsWithSpells5eItemSpellOverrides extends HandlebarsApplicationMixin(ApplicationV2) {\n  constructor(itemWithSpellsItem, itemSpellId) {\n    const itemSpellFlagData = itemWithSpellsItem.itemSpellFlagMap.get(itemSpellId);\n    const itemSpellItem = itemWithSpellsItem.itemSpellItemMap.get(itemSpellId);\n    const id = `${IWS.MODULE_ID}-${itemWithSpellsItem.item.id}-${itemSpellItem.id}`\n\n    // initialise `this` and overwrite the id\n    super({\n      id: id\n    });\n\n    // the parent item's flags for overrides\n    this.overrides = itemSpellFlagData?.overrides ?? {};\n\n    // the spell we are editing\n    this.itemSpellId = itemSpellId;\n\n    // the ItemsWithSpells5eItem instance to use\n    this.itemWithSpellsItem = itemWithSpellsItem;\n\n    // the parent item\n    this.item = itemWithSpellsItem.item;\n\n    // the fake or real spell item\n    this.itemSpellItem = itemSpellItem;\n  }\n\n  static DEFAULT_OPTIONS = {\n    id: IWS.MODULE_ID,\n    tag: \"form\",\n    form: {\n      handler: ItemsWithSpells5eItemSpellOverrides._formHandler,\n      closeOnSubmit: false,\n      submitOnChange: true\n    },\n    position: {\n      width: 560,\n      height: \"auto\"\n    },\n    window: {\n      icon: \"fas fa-wand-sparkles\",\n      title: \"Override Dialog\",\n      contentClasses: ['dnd5e2', 'sheet', 'item', 'iws']\n    }\n  }\n  static PARTS = {\n    form: {\n      template: IWS.TEMPLATES.overrides\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    }\n  }\n\n  get title() {\n    return `${this.item.name} - ${this.itemSpellItem.name}`;\n  }\n\n  _prepareContext() {\n    /* NOG DOEN VOOR EMBEDDED SPELL OVERRIDES\n      If this is an embedded spell, fill the override object with the values of the spell,\n      instead of using the one from the flag.\n      This way, the form correctly reflect the current values on an embedded spell.\n      Values from activities use the first found activity (of its type).\n    */\n    const spell = this.itemSpellItem;\n    const saveActivity = spell.system.activities.getByType(\"save\");\n    const attackActivity = spell.system.activities.getByType(\"attack\");\n    const firstActivity = attackActivity[0] ?? saveActivity[0] ?? spell.isActive ? spell.system.activities.entries().next().value[1] : {};\n    const overrides = this.overrides;\n    const buttonText = `${game.i18n.localize(\"Save\")} & ${game.i18n.localize(\"Close\")}`;\n    const hasUses = this.item.hasLimitedUses && this.item.system?.uses?.max > 0;\n    const abilitiesArray = Object.entries(CONFIG.DND5E.abilities).map(([value, config]) => ({\n      value, label: config.label, group: game.i18n.localize(\"DND5E.Abilities\")\n    }));\n    const ret = {\n      spell,\n      overrides,\n      spellStats: {\n        activity: firstActivity,\n        saveActivity: saveActivity[0] ?? {},\n        attackActivity: attackActivity[0] ?? {},\n        spentUses: spell.isEmbedded ? spell.system.uses.spent : \"\",\n        hasNoFlatDC: overrides.activities?.Saves?.save?.dc?.calculation ?? '',\n        saveAbility: saveActivity[0]?.save?.ability\n      },\n      options: {\n        // Based on dnd5e/module/applications/activity/activity-sheet.mjs:265\n        recoveryPeriods: [\n          {value: \"\", label: \"DND5E.UsesPeriods.Never\"},\n          ...Object.entries(CONFIG.DND5E.limitedUsePeriods)\n          .filter(([, config]) => !config.deprecated)\n          .map(([value, config]) => ({\n            value, label: config.label, group: game.i18n.localize(\"DND5E.DurationTime\")\n          }))\n        ],\n        // Based on dnd5e/module/applications/activity/attack-sheet.mjs:47\n        abilityOptions: [\n          { value: \"noOverride\", label: game.i18n.localize(\"IWS.FORM.NoOverride\") },\n          { rule: true },\n          { value: \"\", label: game.i18n.format(\"DND5E.DefaultSpecific\", {\n            default: game.i18n.localize(\"DND5E.Spellcasting\").toLowerCase() }) },\n          { value: \"none\", label: game.i18n.localize(\"DND5E.None\") },\n          { value: \"spellcasting\", label: game.i18n.localize(\"DND5E.SpellAbility\") },\n          ...abilitiesArray\n        ],\n        // Based on dnd5e/module/applications/activity/save-sheet.mjs:50\n        calculationOptions: [\n          { value: \"noOverride\", label: game.i18n.localize(\"IWS.FORM.NoOverride\") },\n          { rule: true },\n          { value: \"\", label: `${game.i18n.localize(\"DND5E.Flat\")} (${game.i18n.localize(\"DND5E.SAVE.FIELDS.save.dc.CustomFormula\")})` },\n          { value: \"spellcasting\", label: game.i18n.localize(\"DND5E.SpellAbility\") },\n          ...abilitiesArray\n        ],\n        itemUses: [{value: \"itemUses\", label: \"DND5E.CONSUMPTION.Type.ItemUses.Label\" }],\n        parentItem: [{value: this.item.id, label: this.item.name }]\n      },\n      parentItem: {\n        id: this.item.id,\n        name: this.item.name,\n        isEmbedded: this.item.isEmbedded,\n        hasNoUses: !hasUses,\n        hasNoUsesHint: hasUses ? false : 'IWS.FORM.NoUsesHint'\n      },\n      buttons: [\n        { type: \"submit\", icon: \"fa-solid fa-save\", label: buttonText }\n      ],\n      fieldDefault: new foundry.data.fields.StringField(),\n      inputs: {\n        createCheckboxInput: dnd5e.applications.fields.createCheckboxInput\n      }\n    };\n    return ret;\n  }\n\n  static async _formHandler(event, form, formData) {\n    const formDataExpanded = foundry.utils.expandObject(formData.object);\n    this.overrides = formDataExpanded.overrides;\n    if (event instanceof SubmitEvent) {\n      // Button pressed to save and close the form\n      await this.itemWithSpellsItem.updateItemSpellOverrides(this.itemSpellId, this.overrides);\n      this.close();\n    } else {\n      // Save which element has focus\n      const focus = this.element.querySelector(\":focus\");\n      const focusSelector = focus ? `${focus.tagName}[name=\"${focus.name}\"]` : null;\n      // Update the form to reflect the change\n      this.render(null, {focusSelector});\n    }\n  }\n\n   // Copied from dnd5e/module/applications/api/application.mjs:86\n  _onRender(context, options) {\n    super._onRender(context, options);\n\n    // Add special styling for label-top hints.\n    this.element.querySelectorAll(\".label-top > p.hint\").forEach(hint => {\n      const label = hint.parentElement.querySelector(\":scope > label\");\n      if ( !label ) return;\n      hint.ariaLabel = hint.innerText;\n      hint.dataset.tooltip = hint.innerHTML;\n      hint.innerHTML = \"\";\n      label.insertAdjacentElement(\"beforeend\", hint);\n    });\n\n    if (options.focusSelector) {\n      this.element.querySelector(options.focusSelector)?.focus();\n    }\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\nimport {ItemsWithSpells5eItemSheet} from './item-sheet.js';\n\n/**\n * Creates a fake temporary item as filler for when a UUID is unable to resolve an item\n * @param {string} uuid - the `uuid` of the source of this item\n * @returns item with the correct flags to allow deletion\n */\nconst FakeEmptySpell = (uuid, parent) =>\n  new Item.implementation(\n    {\n      name: game.i18n.localize(\"IWS.MISSING_ITEM.Name\"),\n      img: 'icons/svg/hazard.svg',\n      type: 'spell',\n      system: {\n        description: {\n          value: game.i18n.localize(\"IWS.MISSING_ITEM.Description\"),\n        }\n      },\n      _id: uuid.split('.').pop()\n    },\n    {\n      temporary: true,\n      parent\n    }\n  );\n\n/**\n * A class made to make managing the operations for an Item with spells attached easier.\n */\nexport class ItemsWithSpells5eItem {\n  constructor(item) {\n    this.item = item;\n\n    this._itemSpellFlagMap = null;\n    this._itemSpellItems = null;\n  }\n\n  /**\n   * A map of what the \"id\" of the new spell would be to its corresponding flag definition on this parent item\n   * Used when updating an item's overrides as the map lookup is easier than the array lookup\n   */\n  get itemSpellFlagMap() {\n    if (this._itemSpellFlagMap === null) {\n      return this._getItemSpellFlagMap();\n    }\n\n    return this._itemSpellFlagMap;\n  }\n\n  /**\n   * Raw flag data\n   */\n  get itemSpellList() {\n    return this.item.getFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells) ?? [];\n  }\n\n  /**\n   * A map of what the \"id\" of the New spell would be to its corresponding Item Data, taking any defined overrides into account.\n   */\n  get itemSpellItemMap() {\n    if (this._itemSpellItems === null) {\n      return this._getItemSpellItems();\n    }\n\n    return this._itemSpellItems;\n  }\n\n  /**\n   * Update this class's understanding of the item spells\n   */\n  async refresh() {\n    this._getItemSpellFlagMap();\n    await this._getItemSpellItems();\n  }\n\n  /**\n   * Gets the child item from its uuid and provided overrides.\n   * If the uuid points to an item already created on the actor: return that item.\n   * Otherwise create a temporary item, apply overrides, and return that item's json.\n   */\n  async _getChildItem({uuid, overrides = {}}) {\n    // original could be in a compendium or on an actor\n    let original = await fromUuid(uuid);\n\n    // If this 'child' spell has been created on an actor, return that\n    if ([this.item.id, this.item.uuid].includes(IWS.getSpellParentId(original))) {\n      return original;\n    }\n\n    // Create a fake 'empty' item if we could not find the 'child' spell\n    if (!original) {\n      original = FakeEmptySpell(uuid, this.item.parent);\n    }\n\n    // Convert the overrides object into a usable update object\n    const update = IWS.createUpdateObject(this.item, original, overrides);\n\n    // Save the uuid of how the spell is stored in the parentItem's flags into the temporary spell object, so that we know which is its original\n    update[`flags.${IWS.MODULE_ID}.${IWS.FLAGS.knownUuid}`] = uuid;\n\n    const childItem = new Item.implementation(original.toObject(), {\n      temporary: true,\n      keepId: false,\n      parent: this.item.parent\n    });\n    await childItem.updateSource(update);\n\n    return childItem;\n  }\n\n  /**\n   * Get a cached copy of temporary items or create and cache those items with the overrides from flags applied.\n   * @returns {Promise<Map<string, Item5e>>} - array of temporary items created from the uuids and overrides attached to this item\n   */\n  async _getItemSpellItems() {\n    const itemMap = new Map();\n\n    await Promise.all(\n      this.itemSpellList.map(async ({uuid, overrides}) => {\n        const childItem = await this._getChildItem({uuid, overrides});\n\n        if (!childItem) return;\n\n        itemMap.set(childItem.id, childItem);\n        return childItem;\n      })\n    );\n\n    this._itemSpellItems = itemMap;\n    return itemMap;\n  }\n\n  /**\n   * Get or Create a cached map of child spell item \"ids\" to their flags\n   * Useful when updating overrides for a specific 'child spell'\n   * @returns {Map<string, object>} - Map of ids to flags\n   */\n  _getItemSpellFlagMap() {\n    const map = new Map();\n    this.itemSpellList.forEach((itemSpellFlag) => {\n      const id = itemSpellFlag.uuid.split('.').pop();\n      map.set(id, itemSpellFlag);\n    });\n    this._itemSpellFlagMap = map;\n    return map;\n  }\n\n  /**\n   * Adds a given UUID to the item's spell list\n   * @param {string} providedUuid\n   */\n  async addSpellToItem(providedUuid) {\n    // MUTATED if this is an owned item\n    let uuid = providedUuid;\n\n    if (this.item.isEmbedded) {\n      // if this item is already on an actor, we need to\n      // 0. see if the uuid is already on the actor\n      // 1. create the dropped spell on the Actor's item list\n      // 2. get the new uuid from the created spell\n      // 3. add that spell's uuid to this item's flags\n      const spell = await fromUuid(uuid);\n\n      if (!spell) {\n        ui.notifications.error('Item data for', uuid, 'not found');\n        return;\n      }\n      const update = IWS.createUpdateObject(this.item, spell); // the default overrides\n      const adjustedItemData = foundry.utils.mergeObject(spell.toObject(), update);\n\n      const [newItem] = await this.item.actor.createEmbeddedDocuments('Item', [adjustedItemData]);\n      uuid = newItem.uuid;\n    }\n\n    // Update the flag with the linked spells, but don't re-render the item sheet because we need to wait until we refresh to do so\n    const itemSpells = [...this.itemSpellList, {uuid}];\n    const property = `flags.${IWS.MODULE_ID}.${IWS.FLAGS.itemSpells}`;\n    await this.item.update({[property]: itemSpells}, {render: false});\n    // Refresh the itemSpellList and \n    await this.refresh();\n\n    // now re-render the item and actor sheets\n    this.item.render();\n    if (this.item.actor) this.item.actor.render();\n  }\n\n  /**\n   * Removes the relationship between the provided item and this item's spells\n   * @param {string} itemId - the id of the item to remove\n   * @param {Object} options\n   * @param {boolean} [options.alsoDeleteEmbeddedSpell] - Should the spell be deleted also, only for owned items\n   * @returns {Item} the updated or deleted spell after having its parent item removed, or null\n   */\n  async removeSpellFromItem(itemId, {alsoDeleteEmbeddedSpell} = {}) {\n    const itemToDelete = this.itemSpellItemMap.get(itemId);\n\n    // If a sheet for a temporary item is open, close that window\n    if (!this.item.isEmbedded && itemToDelete.sheet.rendered) itemToDelete.sheet.close();\n\n    // If owned, we are storing the actual owned spell item's uuid. Else we stored the source id.\n    const uuidToRemove = this.item.isEmbedded ? itemToDelete.uuid : itemToDelete.getFlag(IWS.MODULE_ID, IWS.FLAGS.knownUuid);\n    const newItemSpells = this.itemSpellList.filter(({uuid}) => uuid !== uuidToRemove);\n\n    // update the data manager's internal store of the items it contains\n    this._itemSpellItems?.delete(itemId);\n    this._itemSpellFlagMap?.delete(itemId);\n\n    await this.item.setFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells, newItemSpells);\n\n    // Nothing more to do for unowned items.\n    if (!this.item.isEmbedded) return;\n\n    // remove the spell's `parentItem` flag\n    const spellItem = fromUuidSync(uuidToRemove);\n\n    // the spell has already been deleted, so do nothing\n    if (!spellItem) return;\n\n    const shouldDeleteSpell = alsoDeleteEmbeddedSpell && (await Dialog.confirm({\n      title: game.i18n.localize(\"IWS.MODULE_NAME\"),\n      content: game.i18n.localize(\"IWS.DIALOG.DeleteOrphanedSpells\")\n    }));\n\n    if (shouldDeleteSpell) return spellItem.delete();\n    else return spellItem.unsetFlag(IWS.MODULE_ID, IWS.FLAGS.parentItem);\n  }\n\n  /**\n   * Updates the given item's overrides\n   * @param {*} itemId - spell attached to this item\n   * @param {*} overrides - object describing what should be changed in the spell\n   */\n  async updateItemSpellOverrides(itemId, overrides) {\n    const itemSpellFlagsToUpdate = this.itemSpellFlagMap.get(itemId);\n    itemSpellFlagsToUpdate.overrides = overrides;\n    this.itemSpellFlagMap.set(itemId, itemSpellFlagsToUpdate);\n    const newItemSpellsFlagValue = [...this.itemSpellFlagMap.values()];\n\n    // this update should not re-render the item sheet because we need to wait until we refresh to do so\n    await this.item.update({[`flags.${IWS.MODULE_ID}.${IWS.FLAGS.itemSpells}`]: newItemSpellsFlagValue}, {render: false});\n\n    // update this data manager's understanding of the items it contains\n    await this.refresh();\n\n    // now re-render the item sheets\n    this.item.render();\n  }\n\n  /**\n   * For API - Get the spells of an item\n   * @public\n   * @param {Item5e[]} item The item to get the attached spells from\n   * @param {boolean} embeddedOnly Only return the items owned by the same actor\n   * @param {Map} providedItems Only return spells included in these items (e.g. pass actor.items)\n   * @returns Map of the items or `null` if item has no spells attached.\n   * Also `null` if embeddedOnly is true and item is not owned by an actor\n   */\n  static async getItemSpells(item, embeddedOnly = false, providedItems = false) {\n    if (typeof item === \"string\") item = await fromUuid(item);\n    if (embeddedOnly && !item.isEmbedded) return null;\n    const ItemsWithSpellsItem = new ItemsWithSpells5eItem(item);\n    if (!ItemsWithSpellsItem.itemSpellList.length) return null;\n    const items = providedItems ?? embeddedOnly ? item.actor?.items : false;\n    if (embeddedOnly && !items) {\n      return null;\n    } else if (items) {\n      const spells = new Map();\n      const itemIds = [item.id ?? item._id, item.uuid];\n      items.forEach(spell => {\n        const parentId = IWS.getSpellParentId(spell);\n        if (itemIds.includes(parentId)) spells.set(spell.id, spell);\n      });\n      return spells;\n    } else {\n      return await ItemsWithSpellsItem.itemSpellItemMap;\n    }\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\nimport {ItemsWithSpells5eItemSpellOverrides} from './item-spell-overrides.js';\nimport {ItemsWithSpells5eItem} from './item.js';\n\nexport {ItemsWithSpells5eItem} // to avoid a circular dependency\n\n/**\n * A class made to make managing the operations for an Item sheet easier.\n */\nexport class ItemsWithSpells5eItemSheet {\n\n  constructor(app, [html]) {\n    this.app = app;\n    this.item = app.item;\n    this.sheetHtml = html;\n    this.itemWithSpellsItem = new ItemsWithSpells5eItem(this.item);\n  }\n\n  /** MUTATED: All open ItemSheet have a cached instance of this class */\n  static instances = new Map();\n\n  /**\n   * Handles the item sheet render hooks.\n   */\n  static init() {\n    Hooks.on('renderItemSheetV2', (app, html) => {\n      // stop if item type is not included or this sheet is tidy5e\n      if ( game.modules.get('tidy5e-sheet')?.api?.isTidy5eItemSheet(app) || !IWS.isIncludedItemType(app.item.type) ) return; // don't do this for tidy5e\n\n      let instance = ItemsWithSpells5eItemSheet.instances.get(app.appId);\n      if (!instance) {\n        instance = new ItemsWithSpells5eItemSheet(app, html);\n        ItemsWithSpells5eItemSheet.instances.set(app.appId, instance);\n      }\n      return instance.renderLite();\n    });\n\n    // Clean up instances as sheets are closed\n    Hooks.on('closeItemSheet', async (app) => {\n      const instance = ItemsWithSpells5eItemSheet.instances.get(app.appId);\n      if (instance) {\n        // Unlink all contained spells\n        await instance._unlinkSpellSheets();\n        // Close this instance\n        return ItemsWithSpells5eItemSheet.instances.delete(app.appId);\n      }\n    });\n\n    // tidy5e\n    Hooks.once('tidy5e-sheet.ready', (api) => {\n      const myTab = new api.models.HtmlTab({\n        title: game.i18n.localize(\"TYPES.Item.spellPl\"),\n        tabId: IWS.MODULE_ID,\n        html: '',\n        enabled(data) {\n          return IWS.isIncludedItemType(data.item.type);\n        },\n        onRender(params) {\n          if (!IWS.isIncludedItemType(params.data.item.type)) return;\n          let app = params.app;\n          let html = [params.element];\n          let instance = ItemsWithSpells5eItemSheet.instances.get(app.appId);\n          if (!instance) {\n            instance = new ItemsWithSpells5eItemSheet(app, html);\n            ItemsWithSpells5eItemSheet.instances.set(app.appId, instance);\n          };\n          return instance.renderHeavy(params.tabContentsElement, false);\n        }\n      });\n      api.registerItemTab(myTab, { autoHeight: true });\n    });\n\n    // Register the tab in DnD5e\n    dnd5e.applications.item.ItemSheet5e2.TABS.push({\n      tab: IWS.MODULE_ID,\n      label: \"TYPES.Item.spellPl\",\n      condition: ItemsWithSpells5eItemSheet._displayTab.bind(this)\n    });\n  }\n\n  /**\n   * Whether or not to show the tab\n   * @param {Item5e} item\n   * @returns {boolean}\n   */\n  static _displayTab(item) {\n    return IWS.isIncludedItemType(item.type) && (game.user.isGM || item.system.identified !== false);\n  }\n\n  /**\n   * Renders the spell tab template to be injected\n   * @param {boolean} bNewTemplate\n   */\n  async _renderSpellsList(bNewTemplate) {\n    // Update flag schema to DnD5e v4.x\n    await IWS.updateFlagsToV4(this.item);\n\n    // Create an array of spells to pass to the template\n    await this.itemWithSpellsItem.refresh(); // Re-create the temporary spells every time\n    const itemSpells = [...(await this.itemWithSpellsItem.itemSpellItemMap).values()].map(spell => {\n      if (spell.hasSave) {\n        spell.activitySave = spell.system.activities.getByType('save')[0];\n        spell.displaySave  = spell.activitySave.labels.save && (spell.isEmbedded || spell.activitySave.save.dc.calculation === '') ? true : false;\n      }\n      if (spell.hasAttack) {\n        spell.activityAttack = spell.system.activities.getByType('attack')[0];\n        spell.displayAttack  = spell.activityAttack.labels.toHit && (spell.isEmbedded || spell.activityAttack.attack.flat) ? true : false;\n      }\n      if (spell.isActive) {\n        // spell.activityFirst = spell.system.activities.entries().next().value[1];\n        let chargeUsingActivities = spell.system.activities.filter(act => act.consumption.targets.some(tar => tar.target === this.item.id));\n        if (chargeUsingActivities.length) {\n          spell.parentConsumption = chargeUsingActivities[0].consumption.targets.filter(tar => tar.target === this.item.id)[0];\n        }\n      }\n      return spell;\n    });\n    const templatePath = bNewTemplate ? IWS.TEMPLATES.spellsTabNew : IWS.TEMPLATES.spellsTab;\n    // options for displaying the attack/save\n    const spellcasting = game.i18n.localize(\"DND5E.Spellcasting\");\n    const abilityCalcOptions = {\n      \"spellcasting\": spellcasting,\n      \"none\": game.i18n.format(\"IWS.TAB.AbilityBased\", {ability: game.i18n.localize(\"DND5E.None\")}),\n    };\n    for (let abi in CONFIG.DND5E.abilities) {\n      abilityCalcOptions[abi] = game.i18n.format(\"IWS.TAB.AbilityBased\", {ability: CONFIG.DND5E.abilities[abi].abbreviation});\n    };\n    const configData = {\n      itemSpells,\n      config: {\n        limitedUsePeriods: CONFIG.DND5E.limitedUsePeriods,\n        abilities: CONFIG.DND5E.abilities,\n        saveCalcOptions: {\n          \"\": game.i18n.localize(\"DND5E.Flat\"),\n          ...abilityCalcOptions\n        },\n        attackCalcOptions: {\n          \"\": spellcasting,\n          ...abilityCalcOptions\n        }\n      },\n      isEmbedded: this.item.isEmbedded,\n      isOwner: this.item.isOwner,\n      concealDetails: !game.user.isGM && (this.item.system.identified === false)\n    };\n    // Link all contained spells to this one\n    await this._linkSpellSheets();\n    // Render the template\n    return renderTemplate(templatePath, configData);\n  }\n\n  /**\n   * Ensure the item dropped is a spell, add the spell to the item flags.\n   * @returns Promise that resolves when the item has been modified\n   */\n  async _dragEnd(event) {\n    if (!this.app.isEditable) return;\n    const data = TextEditor.getDragEventData(event);\n    if (data.type !== 'Item') return;\n    const item = await fromUuid(data.uuid);\n    if (item.type !== 'spell') return;\n    return this.itemWithSpellsItem.addSpellToItem(data.uuid);\n  }\n\n  /**\n   * Event Handler that opens a preview of a linked item's sheet, or uses an embedded item\n   */\n  async _handleItemClick(event) {\n    const spellId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    const spell = this.itemWithSpellsItem.itemSpellItemMap.get(spellId);\n    if (this.item.isEmbedded) {\n      fromUuidSync(spell.uuid).use({ event, legacy: false });\n    } else {\n      spell?.sheet.render(true, {editable: false});\n    }\n  }\n\n  /**\n   * Event Handler that opens the item's sheet to edit\n   */\n  async _handleItemEditClick(event) {\n    const spellId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    const spellTemp = this.itemWithSpellsItem.itemSpellItemMap.get(spellId);\n    let spell = spellTemp;\n    if (!spellTemp.isEmbedded) {\n      const spellUuid = spellTemp.getFlag(IWS.MODULE_ID, IWS.FLAGS.knownUuid);\n      spell = await fromUuid(spellUuid); // could be from a compendium\n    }\n    spell?.sheet.render(true);\n  }\n\n  /**\n   * Event Handler that removes the link between this item and the spell\n   */\n  async _handleItemDeleteClick(event) {\n    const itemId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    return this.itemWithSpellsItem.removeSpellFromItem(itemId);\n  }\n\n  /**\n   * Event Handler that also Deletes the embedded spell\n   */\n  async _handleItemDestroyClick(event) {\n    const itemId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    return this.itemWithSpellsItem.removeSpellFromItem(itemId, {alsoDeleteEmbeddedSpell: true});\n  }\n\n  /**\n   * Event Handler that opens the spell's sheet or config overrides, depending on if the item is owned\n   */\n  async _handleOverridesConfigureClick(event) {\n    const spellId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    const spell = this.itemWithSpellsItem.itemSpellItemMap.get(spellId);\n    if (this.item.isEmbedded) {\n      // NOG AANPASSEN: zodat overrides ook op embedded spells kunnen worden toegepast\n      return fromUuidSync(spell.uuid).sheet.render(true);\n    } else if (spell.sheet.rendered) {\n      // For temporary items, close any open sheet as the configure will create a new temporary item\n      spell.sheet.close();\n    }\n    // pop up a form dialog to configure this item's overrides\n    return new ItemsWithSpells5eItemSpellOverrides(this.itemWithSpellsItem, spellId).render(true);\n  }\n\n  /**\n   * Synchronous part of the render which calls the asynchronous `renderHeavy`\n   * This allows for less delay during the update -> renderItemSheet -> set tab cycle\n   */\n  renderLite() {\n    // Create the tab\n    const div = document.createElement(\"DIV\");\n    const activeClass = this.app._tabs?.[0]?.active === IWS.MODULE_ID ? 'active' : '';\n    const sheetBody = this.sheetHtml.querySelector(\".sheet-body\");\n    div.innerHTML = `<div class=\"tab ${IWS.MODULE_ID} ${activeClass}\" data-group=\"primary\" data-tab=\"${IWS.MODULE_ID}\"></div>`;\n    const spellsTab = div.firstElementChild;\n    sheetBody.appendChild(spellsTab);\n    const bNewTemplate = IWS.VERSIONS.DnD5e_v4;\n    this.renderHeavy(spellsTab, bNewTemplate);\n  }\n\n  /**\n   * Heavy lifting part of the spells tab rendering which involves getting the spells and painting them.\n   * @param {HTMLElement} spellsTab\n   * @param {boolean} bNewTemplate\n   */\n  async renderHeavy(spellsTab, bNewTemplate) {\n    // Add the list to the tab\n    const div = document.createElement(\"DIV\");\n    div.innerHTML = await this._renderSpellsList(bNewTemplate);\n    const c = div.firstElementChild;\n    spellsTab.appendChild(c);\n\n    // Activate Listeners for this ui.\n    c.querySelectorAll(\".item-name\").forEach(n => n.addEventListener(\"click\", this._handleItemClick.bind(this)));\n    c.querySelectorAll(\".configure-overrides\").forEach(n => n.addEventListener(\"click\", this._handleOverridesConfigureClick.bind(this)));\n    c.querySelectorAll(\".item-edit\").forEach(n => n.addEventListener(\"click\", this._handleItemEditClick.bind(this)));\n    c.querySelectorAll(\".item-destroy\").forEach(n => n.addEventListener(\"click\", this._handleItemDestroyClick.bind(this)));\n    c.querySelectorAll(\".item-delete\").forEach(n => n.addEventListener(\"click\", this._handleItemDeleteClick.bind(this)));\n\n    // Register a DragDrop handler for adding new spells to this item\n    const dragDrop = {\n      dragSelector: \".item\",\n      dropSelector: `.${IWS.MODULE_ID}`,\n      permissions: {drop: () => this.app.isEditable && !this.item.isEmbedded},\n      callbacks: {drop: this._dragEnd},\n    };\n    spellsTab.addEventListener(\"drop\", dragDrop.callbacks.drop.bind(this));\n  }\n\n  /**\n   * Link the sheets of linked spells so that updating them updates this item sheet as well\n   */\n  async _linkSpellSheets() {\n    return Promise.all(\n      this.itemWithSpellsItem.itemSpellList.map(async ({uuid, overrides}) => {\n        const spell = await fromUuid(uuid);\n        if (spell) spell.apps[this.app.appId] = this.app;\n        return spell;\n      })\n    );\n  }\n\n  /**\n   * Link the sheets of linked spells so that updating them updates this item sheet as well\n   */\n  async _unlinkSpellSheets() {\n    return Promise.all(\n      this.itemWithSpellsItem.itemSpellList.map(async ({uuid, overrides}) => {\n        const spell = await fromUuid(uuid);\n        if (spell?.apps[this.app.appId]) delete spell.apps[this.app.appId];\n        return spell;\n      })\n    );\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\n\n// the item types that can NEVER have spells in them.\nexport const EXCLUDED_TYPES = [\n  \"class\",\n  \"subclass\",\n  \"background\",\n  \"race\",\n  \"lineage\",\n  \"spell\",\n  \"base\",\n  \"container\",\n  \"backpack\"\n];\n\nexport function _registerSettings() {\n  const TYPES = Item.TYPES.filter(t => !EXCLUDED_TYPES.includes(t));\n\n  for (const type of TYPES) {\n    game.settings.register(IWS.MODULE_ID, `isIncludedItemType${type.titleCase()}`, {\n      scope: \"world\",\n      config: false,\n      type: Boolean,\n      default: true,\n      requiresReload: true\n    });\n  }\n\n  game.settings.register(IWS.MODULE_ID, \"sortOrder\", {\n    name: \"IWS.SETTINGS.SORT_ORDER.NAME\",\n    hint: \"IWS.SETTINGS.SORT_ORDER.HINT\",\n    scope: \"world\",\n    config: true,\n    type: Boolean,\n    default: false,\n    requiresReload: false\n  });\n\n  game.settings.registerMenu(IWS.MODULE_ID, \"itemTypeExclusion\", {\n    name: \"IWS.SETTINGS.ITEM_EXCLUSION.NAME\",\n    hint: \"IWS.SETTINGS.ITEM_EXCLUSION.HINT\",\n    scope: \"world\",\n    config: true,\n    type: IWS_TypeSettings,\n    label: \"IWS.SETTINGS.ITEM_EXCLUSION.NAME\",\n    restricted: true\n  });\n\n  game.settings.register(IWS.MODULE_ID, \"excludeUnequipped\", {\n    name: \"IWS.SETTINGS.EXCLUDE_UNEQUIPPED.NAME\",\n    hint: \"IWS.SETTINGS.EXCLUDE_UNEQUIPPED.HINT\",\n    scope: \"world\",\n    config: true,\n    type: Boolean,\n    default: true,\n    requiresReload: false\n  });\n}\n\nclass IWS_TypeSettings extends FormApplication {\n\n  get id() {\n    return `${IWS.MODULE_ID}-item-type-exclusion-menu`;\n  }\n\n  get title() {\n    return game.i18n.localize(\"IWS.SETTINGS.ITEM_EXCLUSION.TITLE\");\n  }\n\n  get template() {\n    return \"modules/items-with-spells-5e/templates/settingsMenu.hbs\";\n  }\n\n  async getData() {\n    const TYPES = Item.TYPES.filter(t => !EXCLUDED_TYPES.includes(t));\n    const data = await super.getData();\n    data.types = [];\n    for (const type of TYPES) {\n      data.types.push({\n        checked: game.settings.get(IWS.MODULE_ID, `isIncludedItemType${label}`),\n        value: type,\n        label: game.i18n.localize(`TYPES.Item.${type}`)\n      });\n    }\n    return data.sort((a,b) => (a.label > b.label) ? 1 : (a.label < b.label) ? -1 : 0);\n  }\n\n  async _updateObject(event, formData) {\n    Object.entries(formData).forEach(([type, bool]) => {\n      game.settings.set(IWS.MODULE_ID, `isIncludedItemType${type.titleCase()}`, bool);\n    });\n  }\n}\n","import {ItemsWithSpells5e as IWS} from '../classes/defaults.js';\nimport {ItemsWithSpells5eItem as IWSitem} from '../classes/item.js';\nimport {EXCLUDED_TYPES} from '../classes/settings.mjs';\n\nlet ItemsWithSpellsActionHandlerExtender = null\n\nexport class ItemsWithSpells5eExtendHUD {\n  static init() {\n    // only if both TAH Core and DnD5e modules are installed and active\n    if (!game.modules.get('token-action-hud-core')?.active || !game.modules.get('token-action-hud-dnd5e')?.active || !foundry.utils.isNewerVersion(game.modules.get('token-action-hud-dnd5e')?.version, '1.5.6')) return\n\n    // Create the parent group\n    Hooks.once(\"tokenActionHudCoreRegisterDefaults\", async (defaults) => {\n      const name = \"Items with Spells\"\n      const spellsLayout = defaults.layout.find(obj => obj.id === 'spells')\n      const newGroup = {\n        id: IWS.MODULE_ID,\n        name,\n        listName: `Group: ${name}`,\n        type: 'system',\n        nestId: `spells_${IWS.MODULE_ID}`\n      }\n      // Add the group\n      defaults.groups.push(newGroup)\n      // Make it visible at the top of the Spells tab by default\n      spellsLayout.groups.unshift(newGroup)\n    })\n\n    // Extend the class for making a sub-group per item and adding their spells to it\n    Hooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n      ItemsWithSpellsActionHandlerExtender = class ItemsWithSpellsActionHandlerExtender extends coreModule.api.ActionHandlerExtender {\n\n        constructor(actionHandler) {\n          super();\n          this.actionHandler = actionHandler\n          this.actor = null\n          this.iwsExcludeUnequipped = null\n        }\n\n        /**\n         * Extend the action list\n         * @override\n         */\n        async extendActionHandler () {\n          this.actor = this.actionHandler.actor\n          if (!this.actor) return\n\n          this.iwsExcludeUnequipped = game.settings.get(IWS.MODULE_ID, \"excludeUnequipped\")\n\n          const parentGroupData = {\n              id: IWS.MODULE_ID,\n              type: 'system'\n          }\n\n          // iterate over all the items of this actor\n          for (const [key, item] of this.actor.items.entries()) {\n\n            // skip excluded item types\n            if ( EXCLUDED_TYPES.includes(item.type) ) continue\n\n            // skip if item's spells aren't usable\n            const itemUsable = IWS.isUsableItem(item)\n            if ( !itemUsable ) continue\n\n            // get spells of item\n            const actionData = await IWSitem.getItemSpells(item, true, this.actor.items)\n            if ( !actionData ) continue\n\n            // Create a group for this item\n            const info1 = {}\n            const uses = item?.system?.uses\n            if (uses?.max > 0) {\n              const per = uses.recovery[0]?.period === \"charges\" ? \"\" : ` ${game.i18n.localize(\"DND5E.per\")} `;\n              const period = CONFIG.DND5E.limitedUsePeriods[uses.recovery[0]?.period]?.label ?? uses.recovery[0]?.period;\n              const perPeriod = period ? `${per}${period}` : \"\";\n              const remainingUses = uses.max - (uses.spent ?? 0);\n              info1.text = `${remainingUses}/${uses.max}`;\n              info1.title = `${text}${perPeriod}`;\n            }\n            const groupData = {\n                id: `${IWS.MODULE_ID}_${item.id}`,\n                name: item.name,\n                type: 'system-derived',\n                info1,\n                defaultSelected: true,\n                settings: { sort: true }\n            }\n\n            // Add group to HUD\n            this.actionHandler.addGroup(groupData, parentGroupData)\n\n            // Add actions to the group, using the TAH DnD5e Build Actions\n            const actionType = 'spell'\n            const data = { groupData, actionData, actionType }\n            await this.actionHandler.buildActions(data)\n          }\n        }\n      }\n    })\n\n    // Add the new class to TAH workflow\n    Hooks.once(\"tokenActionHudCoreAddActionHandlerExtenders\", async (actionHandler) => {\n      actionHandler.addActionHandlerExtender(new ItemsWithSpellsActionHandlerExtender(actionHandler))\n    })\n\n  }\n}\n","\nimport {ItemsWithSpells5e} from './classes/defaults.js';\nimport {ItemsWithSpells5eActorSheet} from './classes/actor-sheet.js';\nimport {ItemsWithSpells5eActor} from './classes/actor.js';\nimport {ItemsWithSpells5eItem} from './classes/item-sheet.js';\nimport {ItemsWithSpells5eItemSheet} from './classes/item-sheet.js';\nimport {_registerSettings} from './classes/settings.mjs';\nimport {ItemsWithSpells5eExtendHUD} from './extensions/token-action-hud-dnd5e.js';\n\nHooks.once(\"setup\", _registerSettings);\nHooks.once(\"init\", ItemsWithSpells5eActor.init);\nHooks.once(\"init\", ItemsWithSpells5eActorSheet.init);\nHooks.once(\"init\", ItemsWithSpells5e.init);\nHooks.once(\"init\", ItemsWithSpells5eItemSheet.init);\nHooks.once(\"init\", ItemsWithSpells5eExtendHUD.init);\nHooks.once(\"ready\", async () => {\n  const module = game.modules.get(ItemsWithSpells5e.MODULE_ID);\n  module.api = {\n    isIwsItem: ItemsWithSpells5e.isIwsItem,\n    isIwsSpell: ItemsWithSpells5e.getSpellParentId,\n    getItemSpells: ItemsWithSpells5eItem.getItemSpells,\n    getSpellParentId: ItemsWithSpells5e.getSpellParentId,\n    getSpellParentItem: ItemsWithSpells5e.getSpellParentItem,\n    isIncludedItemType: ItemsWithSpells5e.isIncludedItemType,\n    isUsableItem: ItemsWithSpells5e.isUsableItem,\n    updateFlagsToV4: ItemsWithSpells5e.updateFlagsToV4\n  }\n});\n"],"names":["ItemsWithSpells5e","static","itemSpells","parentItem","knownUuid","spellsTabNew","MODULE_ID","spellsTab","overrides","DnD5e_v4","foundry","utils","isNewerVersion","game","system","version","init","preloadTemplates","dnd5e","registerHandlebarsHelpers","loadTemplates","TEMPLATES","isIwsItem","item","fromUuidSync","getFlag","FLAGS","length","getSpellParentId","spell","getSpellParentItem","embeddedOnly","providedItems","fromUuid","isEmbedded","parentId","items","actor","parentIdLast","split","pop","get","isIncludedItemType","itemType","include","settings","titleCase","isUsableItem","identified","equipped","user","isGM","attunement","attuned","attunementRequired","CONFIG","DND5E","attunementTypes","REQUIRED","updateFlagsToV4","itemSpellList","oldType","some","s","changes","newItemSpells","map","updateChangesToV4","update","render","expandObject","uses","max","per","consume","amount","scale","save","scaling","dc","attack","bonus","attackBonus","createUpdateObject","id","tidy5eSectionFlag","flags","section","recovery","period","consumptionTargets","consumption","value","type","target","mode","activity","activities","values","actId","saveActivity","calculation","formula","attackActivity","ability","flat","ItemsWithSpells5eActorSheet","IWS","fn","prepareItemSpellbook","forEach","a","libWrapper","register","wrapped","data","spells","order","nonItemSpells","spellsPerItem","Map","this","uuid","includes","set","push","spellbook","filter","iws","iwsSpells","label","name","usesSlots","canCreate","canPrepare","slots","override","dataset","prop","createSection","sort","b","ItemsWithSpells5eActor","Hooks","on","handleCreateItem","handleDeleteItem","itemDeleted","options","userId","parent","Actor","spellIds","reduce","acc","flag","optionOverride","itemsWithSpells5e","alsoDeleteChildSpells","autoConfirm","Dialog","confirm","title","i18n","localize","content","deleteEmbeddedDocuments","itemCreated","spellUuids","Promise","all","d","_createSpellData","overridesData","spellData","idx","ids","createEmbeddedDocuments","setFlag","fromCompendium","mergeObject","ApplicationV2","HandlebarsApplicationMixin","applications","api","ItemsWithSpells5eItemSpellOverrides","constructor","itemWithSpellsItem","itemSpellId","itemSpellFlagData","itemSpellFlagMap","itemSpellItem","itemSpellItemMap","super","tag","form","handler","_formHandler","closeOnSubmit","submitOnChange","position","width","height","window","icon","contentClasses","template","footer","_prepareContext","getByType","firstActivity","isActive","entries","next","buttonText","hasUses","hasLimitedUses","abilitiesArray","Object","abilities","config","group","spellStats","spentUses","spent","hasNoFlatDC","Saves","saveAbility","recoveryPeriods","limitedUsePeriods","deprecated","abilityOptions","rule","format","default","toLowerCase","calculationOptions","itemUses","hasNoUses","hasNoUsesHint","buttons","fieldDefault","fields","StringField","inputs","createCheckboxInput","event","formData","formDataExpanded","object","SubmitEvent","updateItemSpellOverrides","close","focus","element","querySelector","focusSelector","tagName","_onRender","context","querySelectorAll","hint","parentElement","ariaLabel","innerText","tooltip","innerHTML","insertAdjacentElement","ItemsWithSpells5eItem","_itemSpellFlagMap","_itemSpellItems","_getItemSpellFlagMap","_getItemSpellItems","refresh","_getChildItem","original","Item","implementation","img","description","_id","temporary","FakeEmptySpell","childItem","toObject","keepId","updateSource","itemMap","async","itemSpellFlag","addSpellToItem","providedUuid","ui","notifications","error","adjustedItemData","newItem","property","removeSpellFromItem","itemId","alsoDeleteEmbeddedSpell","itemToDelete","sheet","rendered","uuidToRemove","delete","spellItem","unsetFlag","itemSpellFlagsToUpdate","newItemSpellsFlagValue","getItemSpells","ItemsWithSpellsItem","itemIds","ItemsWithSpells5eItemSheet","app","html","sheetHtml","modules","isTidy5eItemSheet","instance","instances","appId","renderLite","_unlinkSpellSheets","once","myTab","models","HtmlTab","tabId","enabled","onRender","params","renderHeavy","tabContentsElement","registerItemTab","autoHeight","ItemSheet5e2","TABS","tab","condition","_displayTab","bind","_renderSpellsList","bNewTemplate","hasSave","activitySave","displaySave","labels","hasAttack","activityAttack","displayAttack","toHit","chargeUsingActivities","act","targets","tar","parentConsumption","templatePath","spellcasting","abilityCalcOptions","none","abi","abbreviation","configData","saveCalcOptions","attackCalcOptions","isOwner","concealDetails","_linkSpellSheets","renderTemplate","_dragEnd","isEditable","TextEditor","getDragEventData","_handleItemClick","spellId","currentTarget","closest","use","legacy","editable","_handleItemEditClick","spellTemp","spellUuid","_handleItemDeleteClick","_handleItemDestroyClick","_handleOverridesConfigureClick","div","document","createElement","activeClass","_tabs","active","sheetBody","firstElementChild","appendChild","VERSIONS","c","n","addEventListener","dragDrop","dragSelector","dropSelector","permissions","drop","callbacks","apps","EXCLUDED_TYPES","IWS_TypeSettings","FormApplication","getData","TYPES","t","types","checked","_updateObject","bool","ItemsWithSpellsActionHandlerExtender","ItemsWithSpells5eExtendHUD","defaults","spellsLayout","layout","find","obj","newGroup","listName","nestId","groups","unshift","coreModule","ActionHandlerExtender","actionHandler","iwsExcludeUnequipped","extendActionHandler","parentGroupData","key","actionData","IWSitem","info1","perPeriod","remainingUses","text","groupData","defaultSelected","addGroup","actionType","buildActions","addActionHandlerExtender","_registerSettings","scope","Boolean","requiresReload","registerMenu","restricted","isIwsSpell"],"mappings":"AAAO,MAAMA,kBACXC,iBAAmB,uBACnBA,gBAAkB,CAAA,EAClBA,aAAe,CACbC,WAAY,cACZC,WAAY,cACZC,UAAW,iBAEbH,iBAAmB,CACjBI,aAAc,WAAWL,kBAAkBM,yCAC3CC,UAAW,WAAWP,kBAAkBM,qCACxCE,UAAW,WAAWR,kBAAkBM,0CAE1CL,gBAAkB,CAChB,YAAIQ,GAAa,OAAOC,QAAQC,MAAMC,eAAeC,KAAKC,OAAOC,QAAS,IAAO,GAGnF,WAAOC,GACLhB,kBAAkBiB,kBACnB,CAED,uBAAOA,GACLC,MAAMP,MAAMQ,4BACZC,cAAcpB,kBAAkBqB,UACjC,CAQD,gBAAOC,CAAUC,GACK,iBAATA,IAAmBA,EAAOC,aAAaD,IAClD,MAAMrB,EAAaqB,GAAME,QAAQzB,kBAAkBM,UAAWN,kBAAkB0B,MAAMxB,aAAe,GACrG,OAAOA,EAAWyB,OAASzB,EAAa,IACzC,CASD,uBAAO0B,CAAiBC,GAEtB,MADqB,iBAAVA,IAAoBA,EAAQL,aAAaK,IAC7CA,GAAOJ,QAAQzB,kBAAkBM,UAAWN,kBAAkB0B,MAAMvB,aAAe,IAC3F,CAUD,+BAAa2B,CAAmBD,EAAOE,GAAe,EAAOC,GAAgB,GAE3E,GADqB,iBAAVH,IAAoBA,QAAcI,SAASJ,IAClDE,IAAiBF,GAAOK,WAAY,OAAO,KAC/C,MAAMC,EAAWnC,kBAAkB4B,iBAAiBC,GACpD,IAAKM,EAAU,OAAO,KACtB,MAAMC,EAAQJ,GAAiBH,GAAOQ,OAAOD,QAAS,EACtD,GAAIL,IAAiBK,EACnB,OAAO,KACF,GAAIA,EAAO,CAChB,MAAME,EAAeH,EAASI,MAAM,KAAKC,MACzC,OAAOJ,EAAMK,IAAIH,IAAiB,IACxC,CACM,aAAaL,SAASE,EAEzB,CAQD,yBAAOO,CAAmBC,GACxB,IAAIC,GAAU,EACd,IACEA,IAAY/B,KAAKgC,SAASJ,IACxBzC,kBAAkBM,UAClB,qBAAqBqC,EAASG,cAEjC,CAAC,MAAQ,CACV,OAAOF,CACR,CAQD,mBAAOG,CAAaxB,GAGlB,GAFoB,iBAATA,IAAmBA,EAAOC,aAAaD,KAEjB,IAA7BA,GAAMT,QAAQkC,WAAsB,OAAO,EAG/C,GAD6BnC,KAAKgC,SAASJ,IAAIzC,kBAAkBM,UAAW,uBACtB,IAA1BiB,GAAMT,OAAOmC,SAAoB,OAAO,EAEpE,IAAKpC,KAAKqC,KAAKC,KACb,GAAIzC,QAAQC,MAAMC,eAAeC,KAAKC,OAAOC,QAAS,UAAW,CAE/D,GADwD,aAA7BQ,GAAMT,QAAQsC,aACd7B,GAAMT,QAAQuC,QAAS,OAAO,CACjE,KAAa,CACL,MAAMC,EAAqBC,OAAOC,MAAMC,iBAAiBC,UAAY,EACrE,GAAInC,GAAMT,QAAQsC,aAAeE,EAAoB,OAAO,CAC7D,CAEH,OAAO,CACR,CAQD,4BAAaK,CAAgBpC,GAC3B,MAAMqC,EAAgB5D,kBAAkBsB,UAAUC,GAC5CsC,EAAUD,GAAeE,MAAKC,GAAKA,EAAEC,UAE3C,GAAIH,EAAS,CACX,MAAMI,EAAgBL,EAAcM,KAAIH,IAClCA,EAAEC,UACJD,EAAEvD,UAAYR,kBAAkBmE,kBAAkBJ,EAAEC,gBAC7CD,EAAEC,SAEJD,WAEHxC,EAAK6C,OAAO,CAAC,CAAC,SAASpE,kBAAkBM,aAAaN,kBAAkB0B,MAAMxB,cAAe+D,GAAgB,CAACI,QAAQ,GAC7H,CAED,OAAO9C,CACR,CAOD,wBAAO4C,CAAkBH,GACvBA,EAAUtD,QAAQC,MAAM2D,aAAaN,GACrC,MAAMxD,EAAY,CAAA,EAqBlB,GAlBIwD,EAAQlD,QAAQyD,MAAMC,MACxBhE,EAAU,YAAcwD,EAAQlD,OAAOyD,KAAKC,KAE1CR,EAAQlD,QAAQyD,MAAME,MAEQ,YAA5BT,EAAQlD,OAAOyD,KAAKE,MAAmBT,EAAQlD,OAAOyD,KAAKE,IAAM,IACrEjE,EAAU,iBAAmBwD,EAAQlD,OAAOyD,KAAKE,KAI/CT,EAAQlD,QAAQ4D,SAASC,SAC3BnE,EAAU,qBAAuBwD,EAAQlD,OAAO4D,QAAQC,QAEtDX,EAAQlD,QAAQ4D,SAASE,QAC3BpE,EAAU,uBAAyBwD,EAAQlD,OAAO4D,QAAQE,OAIxDZ,EAAQlD,QAAQ+D,MAAMC,QAAS,CACjC,OAAOd,EAAQlD,OAAO+D,KAAKC,SACzB,IAAK,QAEHd,EAAQlD,OAAO+D,KAAKC,QAAU,eAC9B,MACF,IAAK,OAEHd,EAAQlD,OAAO+D,KAAKC,QAAU,GAGlCtE,EAAU,4BAA8BwD,EAAQlD,OAAO+D,KAAKC,OAC7D,CAWD,OAVId,EAAQlD,QAAQ+D,MAAME,KACxBvE,EAAU,wBAA0BwD,EAAQlD,OAAO+D,KAAKE,KAItDf,EAAQlD,QAAQkE,QAAQC,OAASjB,EAAQlD,QAAQoE,eACnD1E,EAAU,wBAA0BwD,EAAQlD,QAAQkE,QAAQC,OAASjB,EAAQlD,QAAQoE,YACrF1E,EAAU,wBAAyB,GAG9BE,QAAQC,MAAM2D,aAAa9D,EACnC,CASD,yBAAO2E,CAAmBhF,EAAY0B,EAAOrB,EAAY,CAAA,GAGvD,MAAM4D,EAAS,CAEb,CAAC,SAASpE,kBAAkBM,aAAaN,kBAAkB0B,MAAMvB,cAAeA,EAAWiF,GAE3F,0BAA2B,SAE3B,oBAAqB,MAIjBC,EAAoBxD,EAAMyD,MAAM,iBAAiBC,QACnDF,IACFjB,EAAO,8BAAgC,MAKrC5D,EAAU+D,MAAMC,MAClBJ,EAAO,mBAAqB5D,EAAU+D,KAAKC,IACvChE,EAAU+D,KAAKiB,SACjBpB,EAAO,wBAA0B,CAAC,CAAEqB,OAAQjF,EAAU+D,KAAKiB,WAE3DpB,EAAO,wBAA0B,MAKrC,MAAMsB,IAAsBlF,EAAUmF,aAAaC,OAAgB,CAAC,CAClEC,KAAM,WACND,MAAOpF,EAAUmF,YAAYC,MAC7BE,OAAQ3F,EAAWiF,GACnBN,QAAS,CAAEiB,KAAQvF,EAAUmF,YAAYb,QAAU,SAAW,MAIhE,IAAK,MAAMkB,KAAYnE,EAAMf,OAAOmF,WAAWC,SAAU,CACvD,MAAMC,EAAQH,EAASZ,GAGvBhB,EAAO,qBAAqB+B,4BAAiC,EAGzDT,IACFtB,EAAO,qBAAqB+B,yBAA+BT,GAIvC,SAAlBM,EAASH,MAAmBrF,EAAU4F,cAAwD,eAAxC5F,EAAU4F,cAAcC,cAChFjC,EAAO,qBAAqB+B,yBAA+B3F,EAAU4F,aAAaC,YACvC,KAAvC7F,EAAU4F,aAAaC,aAAsB7F,EAAU4F,cAAcE,UACvElC,EAAO,qBAAqB+B,qBAA2B3F,EAAU4F,aAAaE,UAK5D,WAAlBN,EAASH,MAAqBrF,EAAU+F,iBACD,eAArC/F,EAAU+F,eAAeC,UAC3BpC,EAAO,qBAAqB+B,oBAA0B3F,EAAU+F,eAAeC,SAE7EhG,EAAU+F,eAAetB,QAC3Bb,EAAO,qBAAqB+B,kBAAwB3F,EAAU+F,eAAetB,OAE3EzE,EAAU+F,eAAeE,OAC3BrC,EAAO,qBAAqB+B,iBAAuB3F,EAAU+F,eAAeE,MAGjF,CAED,OAAOrC,CACR,EC/QI,MAAMsC,4BAEX,WAAO1F,GACL,MAAMoE,EAAKuB,kBAAIrG,UACTsG,EAAKF,4BAA4BG,qBACvC,CAAC,YAAa,OAAOC,SAAQC,IAC3BC,WAAWC,SAAS7B,EAAI,wCAAwC2B,gCAAiCH,EAAI,UAAU,GAElH,CASD,2BAAOC,CAAqBK,EAASC,EAAMC,GACzC,MAAMC,EAAQxG,KAAKgC,SAASJ,IAAIkE,kBAAIrG,UAAW,aAAe,IAAM,EAkB9DgH,EAAgB,GAChBC,EAAgB,IAAIC,IAC1BJ,EAAON,SAASjF,IACd,MAAMM,EAAWwE,kBAAI/E,iBAAiBC,GACtC,GAAKM,GAAYsF,KAAKpF,MAAMD,MAAM0B,MAAKvC,GAAQ,CAACA,EAAK6D,GAAI7D,EAAKmG,MAAMC,SAASxF,KAAa,CACxF,MAAMG,EAAeH,EAASI,MAAM,KAAKC,MACpC+E,EAAc9E,IAAIH,IAAeiF,EAAcK,IAAItF,EAAc,IACtEiF,EAAc9E,IAAIH,GAAcuF,KAAKhG,EAC7C,MACQyF,EAAcO,KAAKhG,EACpB,IAGH,MAAMiG,EAAYZ,EAAQC,EAAMG,GAqBhC,OAlBwBG,KAAKpF,MAAMD,MAAM2F,QAAOxG,IAE9C,IADWoF,kBAAIrF,UAAUC,GAChB,OAAO,EAEhB,OADgBoF,kBAAIjE,mBAAmBnB,EAAKsE,KAC9B,IAIAiB,SAASkB,IACvB,MAAMC,EAAYV,EAAc9E,IAAIuF,EAAI5C,IACxC,IAAK6C,EAAW,OAEhB,IADkBtB,kBAAI5D,aAAaiF,GACnB,OAChB,MAAMzC,EA9Cc,EAACyC,EAAKzD,EAAO,CAAE,EAAE6C,EAAS,MACvC,CACLC,MAAOA,EACPa,MAAOF,EAAIG,KACXC,WAAW,EACXC,WAAW,EACXC,YAAY,EACZlB,SACA7C,KAAMA,EAAKqB,OAAS,IACpB2C,MAAOhE,EAAKC,KAAO,IACnBgE,SAAU,EACVC,QAAS,CAAC,cAAeT,EAAI5C,IAC7BsD,KAAM,QAAQV,EAAI5C,KAkCJuD,CAAcX,EAAKA,EAAIlH,OAAOyD,KAAM0D,GACpDH,EAAUD,KAAKtC,EAAQ,IAGzBuC,EAAUc,MAAK,CAAC7B,EAAG8B,IAAO9B,EAAEM,MAAQwB,EAAExB,OAAWN,EAAEmB,MAAQW,EAAEX,QACtDJ,CACR,ECrEI,MAAMgB,uBAEX,WAAO9H,GACL+H,MAAMC,GAAG,aAAcF,uBAAuBG,kBAC9CF,MAAMC,GAAG,aAAcF,uBAAuBI,iBAC/C,CASD,6BAAaA,CAAiBC,EAAaC,EAASC,GAClD,GAAIA,IAAWxI,KAAKqC,KAAKkC,GAAI,OAC7B,KAAM+D,EAAYG,kBAAkBC,OAAQ,OAC5C,GAAI,CAAC,QAAS,WAAW5B,SAASwB,EAAYG,OAAOzD,MAAO,OAG5D,IADYc,kBAAIrF,UAAU6H,GAChB,OAEV,MAAMK,EAAWL,EAAY9G,MAAMD,MAAMqH,QAAO,CAACC,EAAKnI,KACpD,MAAMoI,EAAOhD,kBAAI/E,iBAAiBL,GAElC,MADI,CAAC4H,EAAY/D,GAAI+D,EAAYzB,MAAMC,SAASgC,IAAOD,EAAI7B,KAAKtG,EAAK6D,IAC9DsE,CAAG,GACT,IAEH,IAAKF,EAAS7H,OAAQ,OAGtB,MAAMiI,EAAiBR,EAAQS,mBAAmBC,sBAC5CC,GAAelJ,KAAKqC,KAAKC,OAA2C,IAAnCgG,EAAYrI,QAAQkC,WAK3D,SAJgB4G,GAAkBG,UAA2BC,OAAOC,QAAQ,CAC1EC,MAAOrJ,KAAKsJ,KAAKC,SAAS,mBAC1BC,QAASxJ,KAAKsJ,KAAKC,SAAS,gCAEVjB,EAAY9G,MAAMiI,wBAAwB,OAAQd,QAAtE,CACD,CAWD,6BAAaP,CAAiBsB,EAAanB,EAASC,GAClD,GAAIA,IAAWxI,KAAKqC,KAAKkC,GAAI,OAC7B,KAAMmF,EAAYjB,kBAAkBC,OAAQ,OAC5C,GAAI,CAAC,QAAS,WAAW5B,SAAS4C,EAAYjB,OAAOzD,MAAO,OAI5D,IADgBc,kBAAIjE,mBAAmB6H,EAAY1E,MACrC,OAGd0E,QAAoB5D,kBAAIhD,gBAAgB4G,GAGxC,MAAMC,EAAa7D,kBAAIrF,UAAUiJ,GACjC,IAAKC,EAAY,OAGjB,MAAMpD,QAAeqD,QAAQC,IAAIF,EAAWtG,KAAIyG,GAAK7B,uBAAuB8B,iBAAiBL,EAAaI,MAGpGE,EAAgB,GAChBC,EAAY1D,EAAOW,QAAO,CAAChE,EAAGgH,MAAQhH,GAAI8G,EAAchD,KAAK2C,EAAWO,IAAMvK,aAM9EwK,SAHsBT,EAAYlI,MAAM4I,wBAAwB,OAAQH,IAGpD5G,KAAI,CAACH,EAAGgH,KAAG,CAAOrD,KAAM3D,EAAE2D,KAAMtC,GAAIrB,EAAEqB,GAAI5E,UAAWqK,EAAcE,OAC7F,OAAOR,EAAYW,QAAQvE,kBAAIrG,UAAWqG,kBAAIjF,MAAMxB,WAAY8K,EACjE,CAQD,6BAAaJ,CAAiBzK,EAAYgH,GACxC,MAAMtF,QAAcI,SAASkF,EAAKO,MAClC,IAAK7F,EAAO,OAAO,KAGnB,MAAMuC,EAASuC,kBAAIxB,mBAAmBhF,EAAY0B,EAAOsF,EAAK3G,WAGxDsK,EAAYjK,KAAKuB,MAAM+I,eAAetJ,GAE5C,OAAOnB,QAAQC,MAAMyK,YAAYN,EAAW1G,EAC7C,ECjGH,MAAMiH,cAAEA,EAAaC,2BAAEA,GAA+B5K,QAAQ6K,aAAaC,IACpE,MAAMC,4CAA4CH,EAA2BD,IAClF,WAAAK,CAAYC,EAAoBC,GAC9B,MAAMC,EAAoBF,EAAmBG,iBAAiBrJ,IAAImJ,GAC5DG,EAAgBJ,EAAmBK,iBAAiBvJ,IAAImJ,GAI9DK,MAAM,CACJ7G,GAJS,GAAGuB,kBAAIrG,aAAaqL,EAAmBpK,KAAK6D,MAAM2G,EAAc3G,OAQ3EqC,KAAKjH,UAAYqL,GAAmBrL,WAAa,CAAA,EAGjDiH,KAAKmE,YAAcA,EAGnBnE,KAAKkE,mBAAqBA,EAG1BlE,KAAKlG,KAAOoK,EAAmBpK,KAG/BkG,KAAKsE,cAAgBA,CACtB,CAED9L,uBAAyB,CACvBmF,GAAIuB,kBAAIrG,UACR4L,IAAK,OACLC,KAAM,CACJC,QAASX,oCAAoCY,aAC7CC,eAAe,EACfC,gBAAgB,GAElBC,SAAU,CACRC,MAAO,IACPC,OAAQ,QAEVC,OAAQ,CACNC,KAAM,uBACN1C,MAAO,kBACP2C,eAAgB,CAAC,SAAU,QAAS,OAAQ,SAGhD5M,aAAe,CACbkM,KAAM,CACJW,SAAUnG,kBAAItF,UAAUb,WAE1BuM,OAAQ,CACND,SAAU,sCAId,SAAI5C,GACF,MAAO,GAAGzC,KAAKlG,KAAK4G,UAAUV,KAAKsE,cAAc5D,MAClD,CAED,eAAA6E,GAOE,MAAMnL,EAAQ4F,KAAKsE,cACb3F,EAAevE,EAAMf,OAAOmF,WAAWgH,UAAU,QACjD1G,EAAiB1E,EAAMf,OAAOmF,WAAWgH,UAAU,UACnDC,EAAgB3G,EAAe,IAAMH,EAAa,IAAMvE,EAAMsL,SAAWtL,EAAMf,OAAOmF,WAAWmH,UAAUC,OAAOzH,MAAM,GAAK,GAC7HpF,EAAYiH,KAAKjH,UACjB8M,EAAa,GAAGzM,KAAKsJ,KAAKC,SAAS,aAAavJ,KAAKsJ,KAAKC,SAAS,WACnEmD,EAAU9F,KAAKlG,KAAKiM,gBAAkB/F,KAAKlG,KAAKT,QAAQyD,MAAMC,IAAM,EACpEiJ,EAAiBC,OAAON,QAAQ7J,OAAOC,MAAMmK,WAAWzJ,KAAI,EAAE0B,EAAOgI,MAAa,CACtFhI,QAAOsC,MAAO0F,EAAO1F,MAAO2F,MAAOhN,KAAKsJ,KAAKC,SAAS,uBA2DxD,MAzDY,CACVvI,QACArB,YACAsN,WAAY,CACV9H,SAAUkH,EACV9G,aAAcA,EAAa,IAAM,CAAE,EACnCG,eAAgBA,EAAe,IAAM,CAAE,EACvCwH,UAAWlM,EAAMK,WAAaL,EAAMf,OAAOyD,KAAKyJ,MAAQ,GACxDC,YAAazN,EAAUyF,YAAYiI,OAAOrJ,MAAME,IAAIsB,aAAe,GACnE8H,YAAa/H,EAAa,IAAIvB,MAAM2B,SAEtC4C,QAAS,CAEPgF,gBAAiB,CACf,CAACxI,MAAO,GAAIsC,MAAO,8BAChBwF,OAAON,QAAQ7J,OAAOC,MAAM6K,mBAC9BtG,QAAO,EAAI,CAAA6F,MAAaA,EAAOU,aAC/BpK,KAAI,EAAE0B,EAAOgI,MAAa,CACzBhI,QAAOsC,MAAO0F,EAAO1F,MAAO2F,MAAOhN,KAAKsJ,KAAKC,SAAS,2BAI1DmE,eAAgB,CACd,CAAE3I,MAAO,aAAcsC,MAAOrH,KAAKsJ,KAAKC,SAAS,wBACjD,CAAEoE,MAAM,GACR,CAAE5I,MAAO,GAAIsC,MAAOrH,KAAKsJ,KAAKsE,OAAO,wBAAyB,CAC5DC,QAAS7N,KAAKsJ,KAAKC,SAAS,sBAAsBuE,iBACpD,CAAE/I,MAAO,OAAQsC,MAAOrH,KAAKsJ,KAAKC,SAAS,eAC3C,CAAExE,MAAO,eAAgBsC,MAAOrH,KAAKsJ,KAAKC,SAAS,0BAChDqD,GAGLmB,mBAAoB,CAClB,CAAEhJ,MAAO,aAAcsC,MAAOrH,KAAKsJ,KAAKC,SAAS,wBACjD,CAAEoE,MAAM,GACR,CAAE5I,MAAO,GAAIsC,MAAO,GAAGrH,KAAKsJ,KAAKC,SAAS,kBAAkBvJ,KAAKsJ,KAAKC,SAAS,+CAC/E,CAAExE,MAAO,eAAgBsC,MAAOrH,KAAKsJ,KAAKC,SAAS,0BAChDqD,GAELoB,SAAU,CAAC,CAACjJ,MAAO,WAAYsC,MAAO,0CACtC/H,WAAY,CAAC,CAACyF,MAAO6B,KAAKlG,KAAK6D,GAAI8C,MAAOT,KAAKlG,KAAK4G,QAEtDhI,WAAY,CACViF,GAAIqC,KAAKlG,KAAK6D,GACd+C,KAAMV,KAAKlG,KAAK4G,KAChBjG,WAAYuF,KAAKlG,KAAKW,WACtB4M,WAAYvB,EACZwB,eAAexB,GAAkB,uBAEnCyB,QAAS,CACP,CAAEnJ,KAAM,SAAU+G,KAAM,mBAAoB1E,MAAOoF,IAErD2B,aAAc,IAAIvO,QAAQyG,KAAK+H,OAAOC,YACtCC,OAAQ,CACNC,oBAAqBnO,MAAMqK,aAAa2D,OAAOG,qBAIpD,CAED,yBAAahD,CAAaiD,EAAOnD,EAAMoD,GACrC,MAAMC,EAAmB9O,QAAQC,MAAM2D,aAAaiL,EAASE,QAE7D,GADAhI,KAAKjH,UAAYgP,EAAiBhP,UAC9B8O,aAAiBI,kBAEbjI,KAAKkE,mBAAmBgE,yBAAyBlI,KAAKmE,YAAanE,KAAKjH,WAC9EiH,KAAKmI,YACA,CAEL,MAAMC,EAAQpI,KAAKqI,QAAQC,cAAc,UACnCC,EAAgBH,EAAQ,GAAGA,EAAMI,iBAAiBJ,EAAM1H,SAAW,KAEzEV,KAAKpD,OAAO,KAAM,CAAC2L,iBACpB,CACF,CAGD,SAAAE,CAAUC,EAAS/G,GACjB6C,MAAMiE,UAAUC,EAAS/G,GAGzB3B,KAAKqI,QAAQM,iBAAiB,uBAAuBtJ,SAAQuJ,IAC3D,MAAMnI,EAAQmI,EAAKC,cAAcP,cAAc,kBACzC7H,IACNmI,EAAKE,UAAYF,EAAKG,UACtBH,EAAK5H,QAAQgI,QAAUJ,EAAKK,UAC5BL,EAAKK,UAAY,GACjBxI,EAAMyI,sBAAsB,YAAaN,GAAK,IAG5CjH,EAAQ4G,eACVvI,KAAKqI,QAAQC,cAAc3G,EAAQ4G,gBAAgBH,OAEtD,EChJI,MAAMe,sBACX,WAAAlF,CAAYnK,GACVkG,KAAKlG,KAAOA,EAEZkG,KAAKoJ,kBAAoB,KACzBpJ,KAAKqJ,gBAAkB,IACxB,CAMD,oBAAIhF,GACF,OAA+B,OAA3BrE,KAAKoJ,kBACApJ,KAAKsJ,uBAGPtJ,KAAKoJ,iBACb,CAKD,iBAAIjN,GACF,OAAO6D,KAAKlG,KAAKE,QAAQkF,kBAAIrG,UAAWqG,kBAAIjF,MAAMxB,aAAe,EAClE,CAKD,oBAAI8L,GACF,OAA6B,OAAzBvE,KAAKqJ,gBACArJ,KAAKuJ,qBAGPvJ,KAAKqJ,eACb,CAKD,aAAMG,GACJxJ,KAAKsJ,6BACCtJ,KAAKuJ,oBACZ,CAOD,mBAAME,EAAcxJ,KAACA,EAAIlH,UAAEA,EAAY,CAAE,IAEvC,IAAI2Q,QAAiBlP,SAASyF,GAG9B,GAAI,CAACD,KAAKlG,KAAK6D,GAAIqC,KAAKlG,KAAKmG,MAAMC,SAAShB,kBAAI/E,iBAAiBuP,IAC/D,OAAOA,EAIJA,IACHA,EApFiB,EAACzJ,EAAM4B,IAC5B,IAAI8H,KAAKC,eACP,CACElJ,KAAMtH,KAAKsJ,KAAKC,SAAS,yBACzBkH,IAAK,uBACLzL,KAAM,QACN/E,OAAQ,CACNyQ,YAAa,CACX3L,MAAO/E,KAAKsJ,KAAKC,SAAS,kCAG9BoH,IAAK9J,EAAKnF,MAAM,KAAKC,OAEvB,CACEiP,WAAW,EACXnI,WAqEWoI,CAAehK,EAAMD,KAAKlG,KAAK+H,SAI5C,MAAMlF,EAASuC,kBAAIxB,mBAAmBsC,KAAKlG,KAAM4P,EAAU3Q,GAG3D4D,EAAO,SAASuC,kBAAIrG,aAAaqG,kBAAIjF,MAAMtB,aAAesH,EAE1D,MAAMiK,EAAY,IAAIP,KAAKC,eAAeF,EAASS,WAAY,CAC7DH,WAAW,EACXI,QAAQ,EACRvI,OAAQ7B,KAAKlG,KAAK+H,SAIpB,aAFMqI,EAAUG,aAAa1N,GAEtBuN,CACR,CAMD,wBAAMX,GACJ,MAAMe,EAAU,IAAIvK,IAcpB,aAZMiD,QAAQC,IACZjD,KAAK7D,cAAcM,KAAI8N,OAAQtK,OAAMlH,gBACnC,MAAMmR,QAAkBlK,KAAKyJ,cAAc,CAACxJ,OAAMlH,cAElD,GAAKmR,EAGL,OADAI,EAAQnK,IAAI+J,EAAUvM,GAAIuM,GACnBA,CAAS,KAIpBlK,KAAKqJ,gBAAkBiB,EAChBA,CACR,CAOD,oBAAAhB,GACE,MAAM7M,EAAM,IAAIsD,IAMhB,OALAC,KAAK7D,cAAckD,SAASmL,IAC1B,MAAM7M,EAAK6M,EAAcvK,KAAKnF,MAAM,KAAKC,MACzC0B,EAAI0D,IAAIxC,EAAI6M,EAAc,IAE5BxK,KAAKoJ,kBAAoB3M,EAClBA,CACR,CAMD,oBAAMgO,CAAeC,GAEnB,IAAIzK,EAAOyK,EAEX,GAAI1K,KAAKlG,KAAKW,WAAY,CAMxB,MAAML,QAAcI,SAASyF,GAE7B,IAAK7F,EAEH,YADAuQ,GAAGC,cAAcC,MAAM,gBAAiB5K,EAAM,aAGhD,MAAMtD,EAASuC,kBAAIxB,mBAAmBsC,KAAKlG,KAAMM,GAC3C0Q,EAAmB7R,QAAQC,MAAMyK,YAAYvJ,EAAM+P,WAAYxN,IAE9DoO,SAAiB/K,KAAKlG,KAAKc,MAAM4I,wBAAwB,OAAQ,CAACsH,IACzE7K,EAAO8K,EAAQ9K,IAChB,CAGD,MAAMxH,EAAa,IAAIuH,KAAK7D,cAAe,CAAC8D,SACtC+K,EAAW,SAAS9L,kBAAIrG,aAAaqG,kBAAIjF,MAAMxB,mBAC/CuH,KAAKlG,KAAK6C,OAAO,CAACqO,CAACA,GAAWvS,GAAa,CAACmE,QAAQ,UAEpDoD,KAAKwJ,UAGXxJ,KAAKlG,KAAK8C,SACNoD,KAAKlG,KAAKc,OAAOoF,KAAKlG,KAAKc,MAAMgC,QACtC,CASD,yBAAMqO,CAAoBC,GAAQC,wBAACA,GAA2B,CAAA,GAC5D,MAAMC,EAAepL,KAAKuE,iBAAiBvJ,IAAIkQ,IAG1ClL,KAAKlG,KAAKW,YAAc2Q,EAAaC,MAAMC,UAAUF,EAAaC,MAAMlD,QAG7E,MAAMoD,EAAevL,KAAKlG,KAAKW,WAAa2Q,EAAanL,KAAOmL,EAAapR,QAAQkF,kBAAIrG,UAAWqG,kBAAIjF,MAAMtB,WACxG6D,EAAgBwD,KAAK7D,cAAcmE,QAAO,EAAEL,UAAUA,IAASsL,IASrE,GANAvL,KAAKqJ,iBAAiBmC,OAAON,GAC7BlL,KAAKoJ,mBAAmBoC,OAAON,SAEzBlL,KAAKlG,KAAK2J,QAAQvE,kBAAIrG,UAAWqG,kBAAIjF,MAAMxB,WAAY+D,IAGxDwD,KAAKlG,KAAKW,WAAY,OAG3B,MAAMgR,EAAY1R,aAAawR,GAG/B,IAAKE,EAAW,OAOhB,OAL0BN,SAAkC5I,OAAOC,QAAQ,CACzEC,MAAOrJ,KAAKsJ,KAAKC,SAAS,mBAC1BC,QAASxJ,KAAKsJ,KAAKC,SAAS,qCAGA8I,EAAUD,SAC5BC,EAAUC,UAAUxM,kBAAIrG,UAAWqG,kBAAIjF,MAAMvB,WAC1D,CAOD,8BAAMwP,CAAyBgD,EAAQnS,GACrC,MAAM4S,EAAyB3L,KAAKqE,iBAAiBrJ,IAAIkQ,GACzDS,EAAuB5S,UAAYA,EACnCiH,KAAKqE,iBAAiBlE,IAAI+K,EAAQS,GAClC,MAAMC,EAAyB,IAAI5L,KAAKqE,iBAAiB5F,gBAGnDuB,KAAKlG,KAAK6C,OAAO,CAAC,CAAC,SAASuC,kBAAIrG,aAAaqG,kBAAIjF,MAAMxB,cAAemT,GAAyB,CAAChP,QAAQ,UAGxGoD,KAAKwJ,UAGXxJ,KAAKlG,KAAK8C,QACX,CAWD,0BAAaiP,CAAc/R,EAAMQ,GAAe,EAAOC,GAAgB,GAErE,GADoB,iBAATT,IAAmBA,QAAaU,SAASV,IAChDQ,IAAiBR,EAAKW,WAAY,OAAO,KAC7C,MAAMqR,EAAsB,IAAI3C,sBAAsBrP,GACtD,IAAKgS,EAAoB3P,cAAcjC,OAAQ,OAAO,KACtD,MAAMS,KAAQJ,GAAiBD,IAAeR,EAAKc,OAAOD,MAC1D,GAAIL,IAAiBK,EACnB,OAAO,KACF,GAAIA,EAAO,CAChB,MAAMgF,EAAS,IAAII,IACbgM,EAAU,CAACjS,EAAK6D,IAAM7D,EAAKiQ,IAAKjQ,EAAKmG,MAK3C,OAJAtF,EAAM0E,SAAQjF,IACZ,MAAMM,EAAWwE,kBAAI/E,iBAAiBC,GAClC2R,EAAQ7L,SAASxF,IAAWiF,EAAOQ,IAAI/F,EAAMuD,GAAIvD,EAAM,IAEtDuF,CACb,CACM,aAAamM,EAAoBvH,gBAEpC,EC5QI,MAAMyH,2BAEX,WAAA/H,CAAYgI,GAAMC,IAChBlM,KAAKiM,IAAMA,EACXjM,KAAKlG,KAAOmS,EAAInS,KAChBkG,KAAKmM,UAAYD,EACjBlM,KAAKkE,mBAAqB,IAAIiF,sBAAsBnJ,KAAKlG,KAC1D,CAGDtB,iBAAmB,IAAIuH,IAKvB,WAAOxG,GACL+H,MAAMC,GAAG,qBAAqB,CAAC0K,EAAKC,KAElC,GAAK9S,KAAKgT,QAAQpR,IAAI,iBAAiB+I,KAAKsI,kBAAkBJ,KAAS/M,kBAAIjE,mBAAmBgR,EAAInS,KAAKsE,MAAQ,OAE/G,IAAIkO,EAAWN,2BAA2BO,UAAUvR,IAAIiR,EAAIO,OAK5D,OAJKF,IACHA,EAAW,IAAIN,2BAA2BC,EAAKC,GAC/CF,2BAA2BO,UAAUpM,IAAI8L,EAAIO,MAAOF,IAE/CA,EAASG,YAAY,IAI9BnL,MAAMC,GAAG,kBAAkBgJ,MAAO0B,IAChC,MAAMK,EAAWN,2BAA2BO,UAAUvR,IAAIiR,EAAIO,OAC9D,GAAIF,EAIF,aAFMA,EAASI,qBAERV,2BAA2BO,UAAUf,OAAOS,EAAIO,MACxD,IAIHlL,MAAMqL,KAAK,sBAAuB5I,IAChC,MAAM6I,EAAQ,IAAI7I,EAAI8I,OAAOC,QAAQ,CACnCrK,MAAOrJ,KAAKsJ,KAAKC,SAAS,sBAC1BoK,MAAO7N,kBAAIrG,UACXqT,KAAM,GACNc,QAAQtN,GACCR,kBAAIjE,mBAAmByE,EAAK5F,KAAKsE,MAE1C,QAAA6O,CAASC,GACP,IAAKhO,kBAAIjE,mBAAmBiS,EAAOxN,KAAK5F,KAAKsE,MAAO,OACpD,IAAI6N,EAAMiB,EAAOjB,IACbC,EAAO,CAACgB,EAAO7E,SACfiE,EAAWN,2BAA2BO,UAAUvR,IAAIiR,EAAIO,OAK5D,OAJKF,IACHA,EAAW,IAAIN,2BAA2BC,EAAKC,GAC/CF,2BAA2BO,UAAUpM,IAAI8L,EAAIO,MAAOF,IAE/CA,EAASa,YAAYD,EAAOE,oBAAoB,EACxD,IAEHrJ,EAAIsJ,gBAAgBT,EAAO,CAAEU,YAAY,GAAO,IAIlD7T,MAAMqK,aAAahK,KAAKyT,aAAaC,KAAKpN,KAAK,CAC7CqN,IAAKvO,kBAAIrG,UACT4H,MAAO,qBACPiN,UAAW1B,2BAA2B2B,YAAYC,KAAK5N,OAE1D,CAOD,kBAAO2N,CAAY7T,GACjB,OAAOoF,kBAAIjE,mBAAmBnB,EAAKsE,QAAUhF,KAAKqC,KAAKC,OAAmC,IAA3B5B,EAAKT,OAAOkC,WAC5E,CAMD,uBAAMsS,CAAkBC,SAEhB5O,kBAAIhD,gBAAgB8D,KAAKlG,YAGzBkG,KAAKkE,mBAAmBsF,UAC9B,MAAM/Q,EAAa,WAAWuH,KAAKkE,mBAAmBK,kBAAkB9F,UAAUhC,KAAIrC,IASpF,GARIA,EAAM2T,UACR3T,EAAM4T,aAAe5T,EAAMf,OAAOmF,WAAWgH,UAAU,QAAQ,GAC/DpL,EAAM6T,eAAe7T,EAAM4T,aAAaE,OAAO9Q,OAAShD,EAAMK,YAAyD,KAA3CL,EAAM4T,aAAa5Q,KAAKE,GAAGsB,cAErGxE,EAAM+T,YACR/T,EAAMgU,eAAiBhU,EAAMf,OAAOmF,WAAWgH,UAAU,UAAU,GACnEpL,EAAMiU,iBAAiBjU,EAAMgU,eAAeF,OAAOI,QAAUlU,EAAMK,aAAcL,EAAMgU,eAAe7Q,OAAOyB,OAE3G5E,EAAMsL,SAAU,CAElB,IAAI6I,EAAwBnU,EAAMf,OAAOmF,WAAW8B,QAAOkO,GAAOA,EAAItQ,YAAYuQ,QAAQpS,MAAKqS,GAAOA,EAAIrQ,SAAW2B,KAAKlG,KAAK6D,OAC3H4Q,EAAsBrU,SACxBE,EAAMuU,kBAAoBJ,EAAsB,GAAGrQ,YAAYuQ,QAAQnO,QAAOoO,GAAOA,EAAIrQ,SAAW2B,KAAKlG,KAAK6D,KAAI,GAErH,CACD,OAAOvD,CAAK,IAERwU,EAAed,EAAe5O,kBAAItF,UAAUhB,aAAesG,kBAAItF,UAAUd,UAEzE+V,EAAezV,KAAKsJ,KAAKC,SAAS,sBAClCmM,EAAqB,CACzBD,aAAgBA,EAChBE,KAAQ3V,KAAKsJ,KAAKsE,OAAO,uBAAwB,CAACjI,QAAS3F,KAAKsJ,KAAKC,SAAS,iBAEhF,IAAK,IAAIqM,KAAOlT,OAAOC,MAAMmK,UAC3B4I,EAAmBE,GAAO5V,KAAKsJ,KAAKsE,OAAO,uBAAwB,CAACjI,QAASjD,OAAOC,MAAMmK,UAAU8I,GAAKC,eAE3G,MAAMC,EAAa,CACjBzW,aACA0N,OAAQ,CACNS,kBAAmB9K,OAAOC,MAAM6K,kBAChCV,UAAWpK,OAAOC,MAAMmK,UACxBiJ,gBAAiB,CACf,GAAI/V,KAAKsJ,KAAKC,SAAS,iBACpBmM,GAELM,kBAAmB,CACjB,GAAIP,KACDC,IAGPrU,WAAYuF,KAAKlG,KAAKW,WACtB4U,QAASrP,KAAKlG,KAAKuV,QACnBC,gBAAiBlW,KAAKqC,KAAKC,OAAyC,IAAhCsE,KAAKlG,KAAKT,OAAOkC,YAKvD,aAFMyE,KAAKuP,mBAEJC,eAAeZ,EAAcM,EACrC,CAMD,cAAMO,CAAS5H,GACb,IAAK7H,KAAKiM,IAAIyD,WAAY,OAC1B,MAAMhQ,EAAOiQ,WAAWC,iBAAiB/H,GACzC,GAAkB,SAAdnI,EAAKtB,KAAiB,OAE1B,MAAkB,iBADC5D,SAASkF,EAAKO,OACxB7B,KACF4B,KAAKkE,mBAAmBuG,eAAe/K,EAAKO,WADnD,CAED,CAKD,sBAAM4P,CAAiBhI,GACrB,MAAMiI,EAAUjI,EAAMkI,cAAcC,QAAQ,kBAAkBhP,QAAQkK,OAChE9Q,EAAQ4F,KAAKkE,mBAAmBK,iBAAiBvJ,IAAI8U,GACvD9P,KAAKlG,KAAKW,WACZV,aAAaK,EAAM6F,MAAMgQ,IAAI,CAAEpI,QAAOqI,QAAQ,IAE9C9V,GAAOiR,MAAMzO,QAAO,EAAM,CAACuT,UAAU,GAExC,CAKD,0BAAMC,CAAqBvI,GACzB,MAAMiI,EAAUjI,EAAMkI,cAAcC,QAAQ,kBAAkBhP,QAAQkK,OAChEmF,EAAYrQ,KAAKkE,mBAAmBK,iBAAiBvJ,IAAI8U,GAC/D,IAAI1V,EAAQiW,EACZ,IAAKA,EAAU5V,WAAY,CACzB,MAAM6V,EAAYD,EAAUrW,QAAQkF,kBAAIrG,UAAWqG,kBAAIjF,MAAMtB,WAC7DyB,QAAcI,SAAS8V,EACxB,CACDlW,GAAOiR,MAAMzO,QAAO,EACrB,CAKD,4BAAM2T,CAAuB1I,GAC3B,MAAMqD,EAASrD,EAAMkI,cAAcC,QAAQ,kBAAkBhP,QAAQkK,OACrE,OAAOlL,KAAKkE,mBAAmB+G,oBAAoBC,EACpD,CAKD,6BAAMsF,CAAwB3I,GAC5B,MAAMqD,EAASrD,EAAMkI,cAAcC,QAAQ,kBAAkBhP,QAAQkK,OACrE,OAAOlL,KAAKkE,mBAAmB+G,oBAAoBC,EAAQ,CAACC,yBAAyB,GACtF,CAKD,oCAAMsF,CAA+B5I,GACnC,MAAMiI,EAAUjI,EAAMkI,cAAcC,QAAQ,kBAAkBhP,QAAQkK,OAChE9Q,EAAQ4F,KAAKkE,mBAAmBK,iBAAiBvJ,IAAI8U,GAC3D,OAAI9P,KAAKlG,KAAKW,WAELV,aAAaK,EAAM6F,MAAMoL,MAAMzO,QAAO,IACpCxC,EAAMiR,MAAMC,UAErBlR,EAAMiR,MAAMlD,QAGP,IAAInE,oCAAoChE,KAAKkE,mBAAoB4L,GAASlT,QAAO,GACzF,CAMD,UAAA6P,GAEE,MAAMiE,EAAMC,SAASC,cAAc,OAC7BC,EAAc7Q,KAAKiM,IAAI6E,QAAQ,IAAIC,SAAW7R,kBAAIrG,UAAY,SAAW,GACzEmY,EAAYhR,KAAKmM,UAAU7D,cAAc,eAC/CoI,EAAIzH,UAAY,mBAAmB/J,kBAAIrG,aAAagY,qCAA+C3R,kBAAIrG,oBACvG,MAAMC,EAAY4X,EAAIO,kBACtBD,EAAUE,YAAYpY,GACtB,MAAMgV,EAAe5O,kBAAIiS,SAASnY,SAClCgH,KAAKmN,YAAYrU,EAAWgV,EAC7B,CAOD,iBAAMX,CAAYrU,EAAWgV,GAE3B,MAAM4C,EAAMC,SAASC,cAAc,OACnCF,EAAIzH,gBAAkBjJ,KAAK6N,kBAAkBC,GAC7C,MAAMsD,EAAIV,EAAIO,kBACdnY,EAAUoY,YAAYE,GAGtBA,EAAEzI,iBAAiB,cAActJ,SAAQgS,GAAKA,EAAEC,iBAAiB,QAAStR,KAAK6P,iBAAiBjC,KAAK5N,SACrGoR,EAAEzI,iBAAiB,wBAAwBtJ,SAAQgS,GAAKA,EAAEC,iBAAiB,QAAStR,KAAKyQ,+BAA+B7C,KAAK5N,SAC7HoR,EAAEzI,iBAAiB,cAActJ,SAAQgS,GAAKA,EAAEC,iBAAiB,QAAStR,KAAKoQ,qBAAqBxC,KAAK5N,SACzGoR,EAAEzI,iBAAiB,iBAAiBtJ,SAAQgS,GAAKA,EAAEC,iBAAiB,QAAStR,KAAKwQ,wBAAwB5C,KAAK5N,SAC/GoR,EAAEzI,iBAAiB,gBAAgBtJ,SAAQgS,GAAKA,EAAEC,iBAAiB,QAAStR,KAAKuQ,uBAAuB3C,KAAK5N,SAG7G,MAAMuR,EAAW,CACfC,aAAc,QACdC,aAAc,IAAIvS,kBAAIrG,YACtB6Y,YAAa,CAACC,KAAM,IAAM3R,KAAKiM,IAAIyD,aAAe1P,KAAKlG,KAAKW,YAC5DmX,UAAW,CAACD,KAAM3R,KAAKyP,WAEzB3W,EAAUwY,iBAAiB,OAAQC,EAASK,UAAUD,KAAK/D,KAAK5N,MACjE,CAKD,sBAAMuP,GACJ,OAAOvM,QAAQC,IACbjD,KAAKkE,mBAAmB/H,cAAcM,KAAI8N,OAAQtK,OAAMlH,gBACtD,MAAMqB,QAAcI,SAASyF,GAE7B,OADI7F,IAAOA,EAAMyX,KAAK7R,KAAKiM,IAAIO,OAASxM,KAAKiM,KACtC7R,CAAK,IAGjB,CAKD,wBAAMsS,GACJ,OAAO1J,QAAQC,IACbjD,KAAKkE,mBAAmB/H,cAAcM,KAAI8N,OAAQtK,OAAMlH,gBACtD,MAAMqB,QAAcI,SAASyF,GAE7B,OADI7F,GAAOyX,KAAK7R,KAAKiM,IAAIO,eAAepS,EAAMyX,KAAK7R,KAAKiM,IAAIO,OACrDpS,CAAK,IAGjB,EClSI,MAAM0X,EAAiB,CAC5B,QACA,WACA,aACA,OACA,UACA,QACA,OACA,YACA,YA+CF,MAAMC,yBAAyBC,gBAE7B,MAAIrU,GACF,MAAO,GAAGuB,kBAAIrG,oCACf,CAED,SAAI4J,GACF,OAAOrJ,KAAKsJ,KAAKC,SAAS,oCAC3B,CAED,YAAI0C,GACF,MAAO,yDACR,CAED,aAAM4M,GACJ,MAAMC,EAAQvI,KAAKuI,MAAM5R,QAAO6R,IAAML,EAAe5R,SAASiS,KACxDzS,QAAa8E,MAAMyN,UACzBvS,EAAK0S,MAAQ,GACb,IAAK,MAAMhU,KAAQ8T,EACjBxS,EAAK0S,MAAMhS,KAAK,CACdiS,QAASjZ,KAAKgC,SAASJ,IAAIkE,kBAAIrG,UAAW,qBAAqB4H,SAC/DtC,MAAOC,EACPqC,MAAOrH,KAAKsJ,KAAKC,SAAS,cAAcvE,OAG5C,OAAOsB,EAAKyB,MAAK,CAAC7B,EAAE8B,IAAO9B,EAAEmB,MAAQW,EAAEX,MAAS,EAAKnB,EAAEmB,MAAQW,EAAEX,OAAU,EAAI,GAChF,CAED,mBAAM6R,CAAczK,EAAOC,GACzB7B,OAAON,QAAQmC,GAAUzI,SAAQ,EAAEjB,EAAMmU,MACvCnZ,KAAKgC,SAAS+E,IAAIjB,kBAAIrG,UAAW,qBAAqBuF,EAAK/C,cAAekX,EAAK,GAElF,ECvFH,IAAIC,EAAuC,KAEpC,MAAMC,2BACX,WAAOlZ,GAEAH,KAAKgT,QAAQpR,IAAI,0BAA0B+V,QAAW3X,KAAKgT,QAAQpR,IAAI,2BAA2B+V,QAAW9X,QAAQC,MAAMC,eAAeC,KAAKgT,QAAQpR,IAAI,2BAA2B1B,QAAS,WAGpMgI,MAAMqL,KAAK,sCAAsCpC,MAAOmI,IACtD,MAAMhS,EAAO,oBACPiS,EAAeD,EAASE,OAAOC,MAAKC,GAAkB,WAAXA,EAAInV,KAC/CoV,EAAW,CACfpV,GAAIuB,kBAAIrG,UACR6H,OACAsS,SAAU,UAAUtS,IACpBtC,KAAM,SACN6U,OAAQ,UAAU/T,kBAAIrG,aAGxB6Z,EAASQ,OAAO9S,KAAK2S,GAErBJ,EAAaO,OAAOC,QAAQJ,EAAS,IAIvCzR,MAAMqL,KAAK,8BAA8BpC,MAAO6I,IAC9CZ,EAAuC,MAAMA,6CAA6CY,EAAWrP,IAAIsP,sBAEvG,WAAApP,CAAYqP,GACV9O,QACAxE,KAAKsT,cAAgBA,EACrBtT,KAAKpF,MAAQ,KACboF,KAAKuT,qBAAuB,IAC7B,CAMD,yBAAMC,GAEJ,GADAxT,KAAKpF,MAAQoF,KAAKsT,cAAc1Y,OAC3BoF,KAAKpF,MAAO,OAEjBoF,KAAKuT,qBAAuBna,KAAKgC,SAASJ,IAAIkE,kBAAIrG,UAAW,qBAE7D,MAAM4a,EAAkB,CACpB9V,GAAIuB,kBAAIrG,UACRuF,KAAM,UAIV,IAAK,MAAOsV,EAAK5Z,KAASkG,KAAKpF,MAAMD,MAAMgL,UAAW,CAGpD,GAAKmM,EAAe5R,SAASpG,EAAKsE,MAAQ,SAI1C,IADmBc,kBAAI5D,aAAaxB,GACjB,SAGnB,MAAM6Z,QAAmBC,sBAAQ/H,cAAc/R,GAAM,EAAMkG,KAAKpF,MAAMD,OACtE,IAAMgZ,EAAa,SAGnB,MAAME,EAAQ,CAAE,EACV/W,EAAOhD,GAAMT,QAAQyD,KAC3B,GAAIA,GAAMC,IAAM,EAAG,CACjB,MAAMC,EAAmC,YAA7BF,EAAKiB,SAAS,IAAIC,OAAuB,GAAK,IAAI5E,KAAKsJ,KAAKC,SAAS,gBAC3E3E,EAASlC,OAAOC,MAAM6K,kBAAkB9J,EAAKiB,SAAS,IAAIC,SAASyC,OAAS3D,EAAKiB,SAAS,IAAIC,OAC9F8V,EAAY9V,EAAS,GAAGhB,IAAMgB,IAAW,GACzC+V,EAAgBjX,EAAKC,KAAOD,EAAKyJ,OAAS,GAChDsN,EAAMG,KAAO,GAAGD,KAAiBjX,EAAKC,MACtC8W,EAAMpR,MAAQ,GAAGuR,OAAOF,GACzB,CACD,MAAMG,EAAY,CACdtW,GAAI,GAAGuB,kBAAIrG,aAAaiB,EAAK6D,KAC7B+C,KAAM5G,EAAK4G,KACXtC,KAAM,iBACNyV,QACAK,iBAAiB,EACjB9Y,SAAU,CAAE+F,MAAM,IAItBnB,KAAKsT,cAAca,SAASF,EAAWR,GAGvC,MACM/T,EAAO,CAAEuU,YAAWN,aAAYS,WADnB,eAEbpU,KAAKsT,cAAce,aAAa3U,EACvC,CACF,EACF,IAIH4B,MAAMqL,KAAK,+CAA+CpC,MAAO+I,IAC/DA,EAAcgB,yBAAyB,IAAI9B,EAAqCc,GAAe,IAGlG,EChGHhS,MAAMqL,KAAK,SFMJ,SAAS4H,oBACd,MAAMrC,EAAQvI,KAAKuI,MAAM5R,QAAO6R,IAAML,EAAe5R,SAASiS,KAE9D,IAAK,MAAM/T,KAAQ8T,EACjB9Y,KAAKgC,SAASoE,SAASN,kBAAIrG,UAAW,qBAAqBuF,EAAK/C,cAAe,CAC7EmZ,MAAO,QACPrO,QAAQ,EACR/H,KAAMqW,QACNxN,SAAS,EACTyN,gBAAgB,IAIpBtb,KAAKgC,SAASoE,SAASN,kBAAIrG,UAAW,YAAa,CACjD6H,KAAM,+BACNkI,KAAM,+BACN4L,MAAO,QACPrO,QAAQ,EACR/H,KAAMqW,QACNxN,SAAS,EACTyN,gBAAgB,IAGlBtb,KAAKgC,SAASuZ,aAAazV,kBAAIrG,UAAW,oBAAqB,CAC7D6H,KAAM,mCACNkI,KAAM,mCACN4L,MAAO,QACPrO,QAAQ,EACR/H,KAAM2T,iBACNtR,MAAO,mCACPmU,YAAY,IAGdxb,KAAKgC,SAASoE,SAASN,kBAAIrG,UAAW,oBAAqB,CACzD6H,KAAM,uCACNkI,KAAM,uCACN4L,MAAO,QACPrO,QAAQ,EACR/H,KAAMqW,QACNxN,SAAS,EACTyN,gBAAgB,GAEpB,IE/CApT,MAAMqL,KAAK,OAAQtL,uBAAuB9H,MAC1C+H,MAAMqL,KAAK,OAAQ1N,4BAA4B1F,MAC/C+H,MAAMqL,KAAK,OAAQpU,kBAAkBgB,MACrC+H,MAAMqL,KAAK,OAAQX,2BAA2BzS,MAC9C+H,MAAMqL,KAAK,OAAQ8F,2BAA2BlZ,MAC9C+H,MAAMqL,KAAK,SAASpC,UACHnR,KAAKgT,QAAQpR,IAAIzC,kBAAkBM,WAC3CkL,IAAM,CACXlK,UAAWtB,kBAAkBsB,UAC7Bgb,WAAYtc,kBAAkB4B,iBAC9B0R,cAAe1C,sBAAsB0C,cACrC1R,iBAAkB5B,kBAAkB4B,iBACpCE,mBAAoB9B,kBAAkB8B,mBACtCY,mBAAoB1C,kBAAkB0C,mBACtCK,aAAc/C,kBAAkB+C,aAChCY,gBAAiB3D,kBAAkB2D,gBACpC"}