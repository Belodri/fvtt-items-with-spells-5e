{"version":3,"file":"items-with-spells-5e.min.js","sources":["classes/defaults.js","classes/actor-sheet.js","classes/actor.js","classes/item-spell-overrides.js","classes/item.js","classes/item-sheet.js","classes/settings.mjs","extensions/token-action-hud-dnd5e.js","init.js"],"sourcesContent":["export class ItemsWithSpells5e {\r\n  static MODULE_ID = 'items-with-spells-5e';\r\n  static SETTINGS = {};\r\n  static FLAGS = {\r\n    itemSpells: 'item-spells',\r\n    parentItem: 'parent-item',\r\n  };\r\n  static TEMPLATES = {\r\n    spellsTab: `modules/${ItemsWithSpells5e.MODULE_ID}/templates/spells-tab.hbs`,\r\n    overrides: `modules/${ItemsWithSpells5e.MODULE_ID}/templates/overrides-form.hbs`,\r\n  };\r\n\r\n  static init() {\r\n    ItemsWithSpells5e.preloadTemplates();\r\n  }\r\n\r\n  static preloadTemplates() {\r\n    dnd5e.utils.registerHandlebarsHelpers();\r\n    loadTemplates(ItemsWithSpells5e.TEMPLATES);\r\n  }\r\n\r\n  /**\r\n   * Test if an item is an items-with-spells-5e item\r\n   * @public\r\n   * @param {Item5e[]} item The item to get the attached spells from\r\n   * @returns the parent item id or `null` if no parent item is found\r\n   */\r\n  static isIwsItem(item) {\r\n    return item.getFlag(ItemsWithSpells5e.MODULE_ID, ItemsWithSpells5e.FLAGS.itemSpells) ?? null;\r\n  }\r\n  /**\r\n   * Test if a spell belongs to an items-with-spells-5e item\r\n   * Alias for getSpellParentId\r\n   * @public\r\n   * @param {Item5e[]} spell The spell with a parent item\r\n   * @returns the parent item id or `null` if no parent item is found\r\n   */\r\n  static isIwsSpell(spell) {\r\n    return ItemsWithSpells5e.getSpellParentId(spell);\r\n  }\r\n\r\n  /**\r\n   * Test if a spell has a parent item by seeing if a parent id is set\r\n   * @public\r\n   * @param {Item5e[]} spell The spell with a parent item\r\n   * @returns the parent item id or `null` if no parent item is found\r\n   */\r\n  static getSpellParentId(spell) {\r\n    return spell.getFlag(ItemsWithSpells5e.MODULE_ID, ItemsWithSpells5e.FLAGS.parentItem) ?? null;\r\n  }\r\n\r\n  /**\r\n   * Get the parent item of a spell on the same actor\r\n   * @public\r\n   * @param {Item5e[]} spell The spell to get the parent item of\r\n   * @param {boolean} embeddedOnly Only return the item if owned by an actor\r\n   * @param {Map} providedItems Only return spells included in these items (e.g. pass actor.items)\r\n   * @returns the parent item or `null` if spell has no parent or parent is not owned by the same actor\r\n   */\r\n  static async getSpellParentItem(spell, embeddedOnly = false, providedItems = false) {\r\n    if (embeddedOnly && !spell.isEmbedded) return null;\r\n    const parentId = ItemsWithSpells5e.getSpellParentId(spell);\r\n    if (!parentId) return null;\r\n    const items = providedItems ?? spell.actor?.items ?? false;\r\n    if (embeddedOnly && !items) {\r\n      return null;\r\n    } else if (items) {\r\n      const parentIdLast = parentId.split('.').pop();\r\n      return items.get(parentIdLast) ?? null;\r\n    } else {\r\n      return await fromUuid(parentId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Test if a type of item is enabled to have the spells tab from items-with-spells-5e\r\n   * @public\r\n   * @param {string} itemType The spell with a parent item\r\n   * @returns {boolean} true if spells tab should be visible\r\n   */\r\n  static isIncludedItemType(itemType) {\r\n    let include = false;\r\n    try {\r\n      include = !!game.settings.get(\r\n        ItemsWithSpells5e.MODULE_ID,\r\n        `isIncludedItemType${itemType.titleCase()}`\r\n      );\r\n    } catch {}\r\n    return include;\r\n  }\r\n\r\n  /**\r\n   * Test if the spells of an item should be shown (item is attuned, equipped, identified)\r\n   * @public\r\n   * @param {Item5e[]} item The parent item of the spell(s)\r\n   * @returns {boolean} true if item should be shown\r\n   */\r\n  static isUsableItem(item) {\r\n    // Unusable if item is not identified\r\n    if (item.system?.identified === false) return false;\r\n    // Unusable if item is not equipped and setting set to exclude based unequipped\r\n    const iwsExcludeUnequipped = game.settings.get(ItemsWithSpells5e.MODULE_ID, \"excludeUnequipped\");\r\n    if (iwsExcludeUnequipped && item.system.equipped === false) return false;\r\n    // Unusable if item is not attuned (but still show to GM)\r\n    if (!game.user.isGM) {\r\n      if (foundry.utils.isNewerVersion(game.system.version, \"3.1.99\")) {\r\n        const attunementRequired = item.system.attunement === \"required\";\r\n        if (!item.system.attuned && attunementRequired) return false;\r\n      } else {\r\n        const attunementRequired = CONFIG.DND5E.attunementTypes?.REQUIRED ?? 1;\r\n        if (item.system?.attunement === attunementRequired) return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n}","import {ItemsWithSpells5e as IWS} from './defaults.js';\n\n/* A class made to make managing the operations for an Actor. */\nexport class ItemsWithSpells5eActorSheet {\n  /* Set up the Actor Sheet Patch */\n  static init() {\n    const id = IWS.MODULE_ID;\n    const fn = ItemsWithSpells5eActorSheet.prepareItemSpellbook;\n    [\"Character\", \"NPC\"].forEach(a => {\n      libWrapper.register(id, `dnd5e.applications.actor.ActorSheet5e${a}.prototype._prepareSpellbook`, fn, \"WRAPPER\");\n    });\n  }\n\n  /**\n   * Filter iws spells into their own sections, removing them from standard sections.\n   * @param {Function} wrapped      A wrapping function.\n   * @param {object} data           The sheet data. **will be mutated**\n   * @param {Item5e[]} spells       The actor's spells.\n   * @returns {object}              The spellbook data.\n   */\n  static prepareItemSpellbook(wrapped, data, spells) {\n    const order = game.settings.get(IWS.MODULE_ID, \"sortOrder\") ? 20 : -5;\n    const createSection = (iws, uses = {}, spells = []) => {\n      return {\n        order: order,\n        label: iws.name,\n        usesSlots: false,\n        canCreate: false,\n        canPrepare: false,\n        spells,\n        uses: uses.value ?? \"-\",\n        slots: uses.max ?? \"-\",\n        override: 0,\n        dataset: {\"iws-item-id\": iws.id},\n        prop: \"item-\"+iws.id\n      };\n    };\n\n    // iterate through spells and put them in respective maps\n    const nonItemSpells = [];\n    const spellsPerItem = new Map();\n    spells.forEach((spell) => {\n      const parentId = IWS.getSpellParentId(spell);\n      if ( parentId && this.actor.items.some(item => [item.id, item.uuid].includes(parentId)) ) {\n        const parentIdLast = parentId.split('.').pop();\n        if (!spellsPerItem.get(parentIdLast)) spellsPerItem.set(parentIdLast, []);\n        spellsPerItem.get(parentIdLast).push(spell);\n      } else {\n        nonItemSpells.push(spell);\n      }\n    });\n\n    const spellbook = wrapped(data, nonItemSpells);\n\n    // get all the items with spells on this actor\n    const itemsWithSpells = this.actor.items.filter(item => {\n      const fl = item.getFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells)?.length;\n      if (!fl) return false;\n      const include = IWS.isIncludedItemType(item.type);\n      return include;\n    });\n\n    // create a new spellbook section for each item with spells attached\n    itemsWithSpells.forEach((iws) => {\n      const iwsSpells = spellsPerItem.get(iws.id);\n      if (!iwsSpells) return;\n      const iwsUsable = IWS.isUsableItem(iws);\n      if (!iwsUsable) return;\n      const section = createSection(iws, iws.system.uses, iwsSpells);\n      spellbook.push(section);\n    });\n\n    spellbook.sort((a, b) => (a.order - b.order) || (a.label - b.label));\n    return spellbook;\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\n\n/**\n * A class made to make managing the operations for an Actor.\n */\nexport class ItemsWithSpells5eActor {\n  /* Set up the create/delete Item hooks. */\n  static init() {\n    Hooks.on('createItem', ItemsWithSpells5eActor.handleCreateItem);\n    Hooks.on('deleteItem', ItemsWithSpells5eActor.handleDeleteItem);\n  }\n\n  /**\n   * When an item is deleted from an actor, find any of its child spells and prompt for those to be deleted.\n   * @param {Item5e} itemDeleted            The parent item that was deleted.\n   * @param {object} options                Deletion options.\n   * @param {string} userId                 The id of the user who performed the deletion.\n   * @returns {Promise<Item5e[]|void>}      The deleted spells.\n   */\n  static async handleDeleteItem(itemDeleted, options, userId) {\n    if (userId !== game.user.id) return;\n    if (!(itemDeleted.parent instanceof Actor)) return;\n    if ([\"group\", \"vehicle\"].includes(itemDeleted.parent.type)) return;\n\n    const ids = itemDeleted.getFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells) ?? [];\n    if (!ids.length) return;\n\n    const spellIds = itemDeleted.actor.items.reduce((acc, item) => {\n      const flag = IWS.getSpellParentId(item);\n      if ([itemDeleted.id, itemDeleted.uuid].includes(flag)) acc.push(item.id);// check uuid, too, for backwards compat.\n      return acc;\n    }, []);\n\n    if (!spellIds.length) return;\n\n    // Ask the player to confirm spell deletion, unless the option for this is set, or unless the item is unidentified and the player doesn't know spells are attached (always ask for GM)\n    const optionOverride = options.itemsWithSpells5e?.alsoDeleteChildSpells;\n    const autoConfirm = !game.user.isGM && itemDeleted.system?.identified === false;\n    const confirm = optionOverride ?? autoConfirm ? true : await Dialog.confirm({\n      title: game.i18n.localize(\"IWS.MODULE_NAME\"),\n      content: game.i18n.localize(\"IWS.QUERY_ALSO_DELETE\")\n    });\n    if (confirm) return itemDeleted.actor.deleteEmbeddedDocuments(\"Item\", spellIds);\n  }\n\n  /**\n   * When an item is created on an actor, if it has any spells to add, create those, and save\n   * a reference to their uuids and ids in the parent item within `flags.<module>.item-spells`.\n   * Each added spell also gets `flags.<module>.parent-item` being the parent item's id.\n   * @param {Item5e} itemCreated      The item with spells that was created.\n   * @param {object} options          Creation options.\n   * @param {string} userId           The id of the user creating the item.\n   * @returns {Promise<Item5e>}       The parent item updated with new flag data.\n   */\n  static async handleCreateItem(itemCreated, options, userId) {\n    if (userId !== game.user.id) return;\n    if (!(itemCreated.parent instanceof Actor)) return;\n    if ([\"group\", \"vehicle\"].includes(itemCreated.parent.type)) return;\n\n    // bail out from creating the spells if the parent item is not valid.\n    const include = IWS.isIncludedItemType(itemCreated.type);\n    if (!include) return;\n\n    // Get array of objects with uuids of spells to create.\n    const spellUuids = itemCreated.getFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells) ?? [];\n    if (!spellUuids.length) return;\n\n    // Create the spells from this item.\n    const spells = await Promise.all(spellUuids.map(d => ItemsWithSpells5eActor._createSpellData(itemCreated, d)));\n    const spellData = spells.filter(s => s);\n    const spellsCreated = await itemCreated.actor.createEmbeddedDocuments(\"Item\", spellData);\n\n    const ids = spellsCreated.map(s => ({uuid: s.uuid, id: s.id}));\n    return itemCreated.setFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells, ids);\n  }\n\n  /**\n   * Create the data for a spell with attack bonus, limited uses, references, and overrides.\n   * @param {Item5e} parentItem     The item that has spells.\n   * @param {object} data           Object with uuid and overrides.\n   * @returns {Promise<object>}     The item data for creation of a spell.\n   */\n  static async _createSpellData(parentItem, data) {\n    const spell = await fromUuid(data.uuid);\n    if (!spell) return null;\n\n    // Adjust attack bonus.\n    const changes = data.changes?.system || {};\n    if (changes.attackBonus) {\n      changes.ability = \"none\";\n      changes.attackBonus = `${changes.attackBonus || 0} - @prof`;\n    }\n\n    // Adjust limited uses.\n    const usesMax = changes.uses?.max;\n    if (usesMax) {\n      const rollData = parentItem.getRollData({deterministic: true});\n      changes.uses.value = dnd5e.utils.simplifyBonus(usesMax, rollData);\n    }\n\n    // Adjust item id for consumption.\n    if (changes.consume?.amount) {\n      changes.consume.type = \"charges\";\n      changes.consume.target = parentItem.id;\n    }\n\n    // Create and return spell data.\n    const spellData = game.items.fromCompendium(spell);\n    const mergeData = {\n      [`flags.${IWS.MODULE_ID}.${IWS.FLAGS.parentItem}`]: parentItem.id,\n      system: {...changes, \"preparation.mode\": \"atwill\"}\n    };\n    const tidy5eSectionFlag = spell.flags['tidy5e-sheet']?.section;\n    if (tidy5eSectionFlag) {\n      mergeData['flags.tidy5e-sheet.section'] = null;\n    }\n    return foundry.utils.mergeObject(spellData, mergeData);\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\n\n/**\n * The form to control Item Spell overrides (e.g. for consumption logic)\n */\nexport class ItemsWithSpells5eItemSpellOverrides extends FormApplication {\n  constructor(itemWithSpellsItem, itemSpellId) {\n    const itemSpellFlagData = itemWithSpellsItem.itemSpellFlagMap.get(itemSpellId);\n    // set the `object` of this FormApplication as the itemSpell data from the parent item's flags\n    super(itemSpellFlagData?.changes ?? {});\n\n    // the spell we are editing\n    this.itemSpellId = itemSpellId;\n\n    // the ItemsWithSpells5eItem instance to use\n    this.itemWithSpellsItem = itemWithSpellsItem;\n\n    // the parent item\n    this.item = itemWithSpellsItem.item;\n\n    // the fake or real spell item\n    this.itemSpellItem = itemWithSpellsItem.itemSpellItemMap.get(itemSpellId);\n  }\n\n  get id() {\n    return `${IWS.MODULE_ID}-${this.item.id}-${this.itemSpellItem.id}`;\n  }\n\n  get title() {\n    return `${this.item.name} - ${this.itemSpellItem.name}`;\n  }\n\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['dnd5e', 'sheet', 'item', \"iws\"],\n      template: IWS.TEMPLATES.overrides,\n      width: 560,\n      closeOnSubmit: false,\n      submitOnChange: true,\n      height: 'auto'\n    });\n  }\n\n  getData() {\n    const uses = this.item.system.uses || {};\n    const ret = {\n      hasAttack: this.itemSpellItem.hasAttack,\n      hasSave: this.itemSpellItem.hasSave,\n      save: this.itemSpellItem.system.save,\n      overrides: this.object,\n      config: {\n        limitedUsePeriods: CONFIG.DND5E.limitedUsePeriods,\n        abilities: CONFIG.DND5E.abilities,\n        spellLevels: CONFIG.DND5E.spellLevels,\n        // Temporary custom object to use selectOptions until DnD5e gets v12 compliant\n        saveScaling: {\n          \"spell\": { label: \"DND5E.Spellcasting\" },\n          ...CONFIG.DND5E.abilities,\n          \"flat\": { label: \"DND5E.Flat\" }\n        }\n      },\n      isFlatDC: this.object?.system?.save?.scaling === 'flat',\n      spell: this.itemSpellItem,\n      parentItem: {\n        id: this.item.id,\n        name: this.item.name,\n        isEmbedded: this.item.isEmbedded,\n        hasUses: this.item.hasLimitedUses && (uses.per in CONFIG.DND5E.limitedUsePeriods) && (uses.max > 0)\n      }\n    };\n    return ret;\n  }\n\n  async _updateObject(event, formData) {\n    const formDataExpanded = foundry.utils.expandObject(formData);\n    await this.itemWithSpellsItem.updateItemSpellOverrides(this.itemSpellId, formDataExpanded.overrides);\n    this.object = formDataExpanded.overrides;\n\n    if (this.item.isEmbedded) {\n      ui.notifications.warn('The existing spells on the parent actor will not be modified to reflect this change.');\n    }\n\n    // close if this is a submit (button press or `enter` key)\n    if (event instanceof SubmitEvent) this.close();\n    else this.render();\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\nimport {ItemsWithSpells5eItemSheet} from './item-sheet.js';\n\n/**\n * Creates a fake temporary item as filler for when a UUID is unable to resolve an item\n * @param {string} uuid - the `uuid` of the source of this item\n * @returns item with the correct flags to allow deletion\n */\nconst FakeEmptySpell = (uuid, parent) =>\n  new Item.implementation(\n    {\n      name: game.i18n.localize(\"IWS.MISSING_ITEM\"),\n      img: 'icons/svg/hazard.svg',\n      type: 'spell',\n      system: {\n        description: {\n          value: game.i18n.localize(\"IWS.MISSING_ITEM_DESCRIPTION\"),\n        }\n      },\n      _id: uuid.split('.').pop()\n    },\n    {\n      temporary: true,\n      parent\n    }\n  );\n\n/**\n * A class made to make managing the operations for an Item with spells attached easier.\n */\nexport class ItemsWithSpells5eItem {\n  constructor(item) {\n    this.item = item;\n\n    this._itemSpellFlagMap = null;\n    this._itemSpellItems = null;\n  }\n\n  /**\n   * A map of what the \"id\" of the new spell would be to its corresponding flag definition on this parent item\n   * Used when updating an item's overrides as the map lookup is easier than the array lookup\n   */\n  get itemSpellFlagMap() {\n    if (this._itemSpellFlagMap === null) {\n      return this._getItemSpellFlagMap();\n    }\n\n    return this._itemSpellFlagMap;\n  }\n\n  /**\n   * Raw flag data\n   */\n  get itemSpellList() {\n    return this.item.getFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells) ?? [];\n  }\n\n  /**\n   * A map of what the \"id\" of the New spell would be to its corresponding Item Data, taking any defined overrides into account.\n   */\n  get itemSpellItemMap() {\n    if (this._itemSpellItems === null) {\n      return this._getItemSpellItems();\n    }\n\n    return this._itemSpellItems;\n  }\n\n  /**\n   * Update this class's understanding of the item spells\n   */\n  async refresh() {\n    this._getItemSpellFlagMap();\n    await this._getItemSpellItems();\n  }\n\n  /**\n   * Gets the child item from its uuid and provided changes.\n   * If the uuid points to an item already created on the actor: return that item.\n   * Otherwise create a temporary item, apply changes, and return that item's json.\n   */\n  async _getChildItem({uuid, changes = {}}) {\n    // original could be in a compendium or on an actor\n    let original = await fromUuid(uuid);\n\n    // return a fake 'empty' item if we could not create a childItem\n    if (!original) {\n      original = FakeEmptySpell(uuid, this.item.parent);\n    }\n\n    // this exists if the 'child' spell has been created on an actor\n    if (original.getFlag(IWS.MODULE_ID, IWS.FLAGS.parentItem) === this.item.uuid) {\n      return original;\n    }\n\n    // merge with the changes that always need to be applied\n    const update = foundry.utils.mergeObject(changes, this._getFlagFixObject(original, uuid));\n\n    // backfill the 'charges' and 'target' for parent-item-charge consumption style spells\n    if (foundry.utils.getProperty(changes, 'system.consume.amount')) {\n      foundry.utils.mergeObject(update, {\n        'system.consume.type': 'charges',\n        'system.consume.target': this.item.id\n      });\n    }\n\n    const childItem = new Item.implementation(original.toObject(), {\n      temporary: true,\n      keepId: false,\n      parent: this.item.parent,\n      \n    });\n    await childItem.updateSource(update);\n\n    return childItem;\n  }\n\n  /**\n   * Get a cached copy of temporary items or create and cache those items with the changes from flags applied.\n   * @returns {Promise<Map<string, Item5e>>} - array of temporary items created from the uuids and changes attached to this item\n   */\n  async _getItemSpellItems() {\n    const itemMap = new Map();\n\n    await Promise.all(\n      this.itemSpellList.map(async ({uuid, changes}) => {\n        const childItem = await this._getChildItem({uuid, changes});\n\n        if (!childItem) return;\n\n        itemMap.set(childItem.id, childItem);\n        return childItem;\n      })\n    );\n\n    this._itemSpellItems = itemMap;\n    return itemMap;\n  }\n\n  /**\n   * Get or Create a cached map of child spell item \"ids\" to their flags\n   * Useful when updating overrides for a specific 'child spell'\n   * @returns {Map<string, object>} - Map of ids to flags\n   */\n  _getItemSpellFlagMap() {\n    const map = new Map();\n    this.itemSpellList.forEach((itemSpellFlag) => {\n      const id = itemSpellFlag.uuid.split('.').pop();\n      map.set(id, itemSpellFlag);\n    });\n    this._itemSpellFlagMap = map;\n    return map;\n  }\n\n  /**\n   * Returns an object to merge into the spells object to apply/fix flags\n   * @param {string} providedUuid\n   * @returns {object}\n   */\n  _getFlagFixObject(item, providedUuid) {\n    // Foundry v12 uses '_stats.compendiumSource' instead of 'flags.core.sourceId'\n    const sourceIdFlag = foundry.utils.isNewerVersion(game.version, \"11.999\") ? '_stats.compendiumSource' : 'flags.core.sourceId';\n    const changes = {\n      [sourceIdFlag]: providedUuid, // set the sourceId as the original spell\n      [`flags.${IWS.MODULE_ID}.${IWS.FLAGS.parentItem}`]: this.item.uuid,\n      'system.preparation.mode': 'atwill'\n    };\n    const tidy5eSectionFlag = item.flags['tidy5e-sheet']?.section;\n    if (tidy5eSectionFlag) {\n      changes['flags.tidy5e-sheet.section'] = null;\n    }\n    return changes;\n  }\n\n  /**\n   * Adds a given UUID to the item's spell list\n   * @param {string} providedUuid\n   */\n  async addSpellToItem(providedUuid) {\n    // MUTATED if this is an owned item\n    let uuid = providedUuid;\n\n    if (this.item.isEmbedded) {\n      // if this item is already on an actor, we need to\n      // 0. see if the uuid is already on the actor\n      // 1. create the dropped uuid on the Actor's item list (OR update that item to be a child of this one)\n      // 2. get the new uuid from the created item\n      // 3. add that uuid to this item's flags\n      const fullItemData = await fromUuid(uuid);\n\n      if (!fullItemData) {\n        ui.notifications.error('Item data for', uuid, 'not found');\n        return;\n      }\n      const changes = this._getFlagFixObject(fullItemData, providedUuid);\n      const adjustedItemData = foundry.utils.mergeObject(fullItemData.toObject(), changes);\n\n      const [newItem] = await this.item.actor.createEmbeddedDocuments('Item', [adjustedItemData]);\n      uuid = newItem.uuid;\n    }\n\n    const itemSpells = [...this.itemSpellList, {uuid}];\n\n    // this update should not re-render the item sheet because we need to wait until we refresh to do so\n    const property = `flags.${IWS.MODULE_ID}.${IWS.FLAGS.itemSpells}`;\n    await this.item.update({[property]: itemSpells}, {render: false});\n\n    await this.refresh();\n\n    // now re-render the item and actor sheets\n    this.item.render();\n    if (this.item.actor) this.item.actor.render();\n  }\n\n  /**\n   * Removes the relationship between the provided item and this item's spells\n   * @param {string} itemId - the id of the item to remove\n   * @param {Object} options\n   * @param {boolean} [options.alsoDeleteEmbeddedSpell] - Should the spell be deleted also, only for owned items\n   * @returns {Item} the updated or deleted spell after having its parent item removed, or null\n   */\n  async removeSpellFromItem(itemId, {alsoDeleteEmbeddedSpell} = {}) {\n    const itemToDelete = this.itemSpellItemMap.get(itemId);\n\n    // If owned, we are storing the actual owned spell item's uuid. Else we store the source id.\n    const uuidToRemove = this.item.isEmbedded ? itemToDelete.uuid : await itemToDelete.getFlag(\"core\", \"sourceId\");\n    const newItemSpells = this.itemSpellList.filter(({uuid}) => uuid !== uuidToRemove);\n\n    // update the data manager's internal store of the items it contains\n    this._itemSpellItems?.delete(itemId);\n    this._itemSpellFlagMap?.delete(itemId);\n\n    await this.item.setFlag(IWS.MODULE_ID, IWS.FLAGS.itemSpells, newItemSpells);\n\n    // Nothing more to do for unowned items.\n    if (!this.item.isEmbedded) return;\n\n    // remove the spell's `parentItem` flag\n    const spellItem = fromUuidSync(uuidToRemove);\n\n    // the other item has already been deleted, probably do nothing.\n    if (!spellItem) return;\n\n    const shouldDeleteSpell = alsoDeleteEmbeddedSpell && (await Dialog.confirm({\n      title: game.i18n.localize(\"IWS.MODULE_NAME\"),\n      content: game.i18n.localize(\"IWS.WARN_ALSO_DELETE\")\n    }));\n\n    if (shouldDeleteSpell) return spellItem.delete();\n    else return spellItem.unsetFlag(IWS.MODULE_ID, IWS.FLAGS.parentItem);\n  }\n\n  /**\n   * Updates the given item's overrides\n   * @param {*} itemId - spell attached to this item\n   * @param {*} overrides - object describing the changes that should be applied to the spell\n   */\n  async updateItemSpellOverrides(itemId, overrides) {\n    const itemSpellFlagsToUpdate = this.itemSpellFlagMap.get(itemId);\n    itemSpellFlagsToUpdate.changes = overrides;\n    this.itemSpellFlagMap.set(itemId, itemSpellFlagsToUpdate);\n    const newItemSpellsFlagValue = [...this.itemSpellFlagMap.values()];\n\n    // this update should not re-render the item sheet because we need to wait until we refresh to do so\n    await this.item.update({[`flags.${IWS.MODULE_ID}.${IWS.FLAGS.itemSpells}`]: newItemSpellsFlagValue}, {render: false});\n\n    // update this data manager's understanding of the items it contains\n    await this.refresh();\n\n    ItemsWithSpells5eItemSheet.instances.forEach((instance) => {\n      if (instance.itemWithSpellsItem === this) instance._shouldOpenSpellsTab = true;\n    });\n\n    // now re-render the item sheets\n    this.item.render();\n  }\n\n  /**\n   * For API - Get the spells of an item\n   * @public\n   * @param {Item5e[]} item The item to get the attached spells from\n   * @param {boolean} embeddedOnly Only return the items owned by the same actor\n   * @param {Map} providedItems Only return spells included in these items (e.g. pass actor.items)\n   * @returns Map of the items or `null` if item has no spells attached.\n   * Also `null` if embeddedOnly is true and item is not owned by an actor\n   */\n  static async getItemSpells(item, embeddedOnly = false, providedItems = false) {\n    if (typeof item === \"string\") item = await fromUuid(item);\n    if (embeddedOnly && !item.isEmbedded) return null;\n    const ItemsWithSpellsItem = new ItemsWithSpells5eItem(item);\n    if (!ItemsWithSpellsItem.itemSpellList.length) return null;\n    const items = providedItems ?? embeddedOnly ? item.actor?.items : false;\n    if (embeddedOnly && !items) {\n      return null;\n    } else if (items) {\n      const spells = new Map();\n      const itemIds = [item.id ?? item._id, item.uuid];\n      items.forEach(spell => {\n        const parentId = IWS.getSpellParentId(spell);\n        if (itemIds.includes(parentId)) spells.set(spell.id, spell);\n      });\n      return spells;\n    } else {\n      return await ItemsWithSpellsItem.itemSpellItemMap;\n    }\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\nimport {ItemsWithSpells5eItemSpellOverrides} from './item-spell-overrides.js';\nimport {ItemsWithSpells5eItem} from './item.js';\n\nexport {ItemsWithSpells5eItem} // to avoid a circular dependency\n\n/**\n * A class made to make managing the operations for an Item sheet easier.\n */\nexport class ItemsWithSpells5eItemSheet {\n  /** A boolean to set when we are causing an item update we know should re-open to this tab */\n  _shouldOpenSpellsTab = false;\n\n  constructor(app, [html]) {\n    this.app = app;\n    this.item = app.item;\n    this.sheetHtml = html;\n    this.itemWithSpellsItem = new ItemsWithSpells5eItem(this.item);\n  }\n\n  /** MUTATED: All open ItemSheet have a cached instance of this class */\n  static instances = new Map();\n\n  /**\n   * Handles the item sheet render hooks.\n   */\n  static init() {\n    Hooks.on('renderItemSheet', (app, html) => {\n      // stop if item type is not included or this sheet is tidy5e\n      if ( game.modules.get('tidy5e-sheet')?.api?.isTidy5eItemSheet(app) || !IWS.isIncludedItemType(app.item.type) ) return; // don't do this for tidy5e\n\n      const instance = ItemsWithSpells5eItemSheet.instances.get(app.appId);\n      if (instance) {\n        instance.renderLite();\n        if (instance._shouldOpenSpellsTab) {\n          app._tabs?.[0]?.activate?.('spells');\n          instance._shouldOpenSpellsTab = false;\n        }\n        return;\n      }\n      const newInstance = new ItemsWithSpells5eItemSheet(app, html);\n      ItemsWithSpells5eItemSheet.instances.set(app.appId, newInstance);\n      return newInstance.renderLite();\n    });\n\n    // clean up instances as sheets are closed\n    Hooks.on('closeItemSheet', async (app) => {\n      if (ItemsWithSpells5eItemSheet.instances.get(app.appId)) {\n        return ItemsWithSpells5eItemSheet.instances.delete(app.appId);\n      }\n    });\n\n    // tidy5e\n    Hooks.once('tidy5e-sheet.ready', (api) => {\n      const myTab = new api.models.HtmlTab({\n        title: game.i18n.localize(\"TYPES.Item.spellPl\"),\n        tabId: 'items-with-spells-5e',\n        html: '',\n        enabled(data) {\n          return IWS.isIncludedItemType(data.item.type);\n        },\n        onRender(params) {\n          if (!IWS.isIncludedItemType(params.data.item.type)) return;\n          let app = params.app;\n          let html = [params.element];\n          const instance = ItemsWithSpells5eItemSheet.instances.get(app.appId);\n          if (instance) {\n            instance.renderHeavy(params.tabContentsElement);\n          } else {\n            const newInstance = new ItemsWithSpells5eItemSheet(app, html);\n            ItemsWithSpells5eItemSheet.instances.set(app.appId, newInstance);\n            newInstance.renderHeavy(params.tabContentsElement);\n          };\n        }\n      });\n      api.registerItemTab(myTab, { autoHeight: true });\n    });\n  }\n\n  /**\n   * Renders the spell tab template to be injected\n   */\n  async _renderSpellsList() {\n    const itemSpellsArray = [...(await this.itemWithSpellsItem.itemSpellItemMap).values()];\n\n    return renderTemplate(IWS.TEMPLATES.spellsTab, {\n      itemSpells: itemSpellsArray,\n      config: {\n        limitedUsePeriods: CONFIG.DND5E.limitedUsePeriods,\n        abilities: CONFIG.DND5E.abilities,\n      },\n      isEmbedded: this.item.isEmbedded,\n      isOwner: this.item.isOwner,\n      concealDetails: !game.user.isGM && (this.item.system.identified === false)\n    });\n  }\n\n  /**\n   * Ensure the item dropped is a spell, add the spell to the item flags.\n   * @returns Promise that resolves when the item has been modified\n   */\n  async _dragEnd(event) {\n    if (!this.app.isEditable) return;\n    const data = TextEditor.getDragEventData(event);\n    if (data.type !== 'Item') return;\n    const item = fromUuidSync(data.uuid);\n    if (item.type !== 'spell') return;\n    // set the flag to re-open this tab when the update completes\n    this._shouldOpenSpellsTab = true;\n    return this.itemWithSpellsItem.addSpellToItem(data.uuid);\n  }\n\n  /**\n   * Event Handler that opens the item's sheet\n   */\n  async _handleItemClick(event) {\n    const itemId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    const item = this.itemWithSpellsItem.itemSpellItemMap.get(itemId);\n    item?.sheet.render(true, {editable: !!item.isOwner && !!item.isEmbedded});\n  }\n\n  /**\n   * Event Handler that removes the link between this item and the spell\n   */\n  async _handleItemDeleteClick(event) {\n    const itemId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    // set the flag to re-open this tab when the update completes\n    this._shouldOpenSpellsTab = true;\n    return this.itemWithSpellsItem.removeSpellFromItem(itemId);\n  }\n\n  /**\n   * Event Handler that also Deletes the embedded spell\n   */\n  async _handleItemDestroyClick(event) {\n    const itemId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    // set the flag to re-open this tab when the update completes\n    this._shouldOpenSpellsTab = true;\n    return this.itemWithSpellsItem.removeSpellFromItem(itemId, {alsoDeleteEmbeddedSpell: true});\n  }\n\n  /**\n   * Event Handler that opens the item's sheet or config overrides, depending on if the item is owned\n   */\n  async _handleItemEditClick(event) {\n    const itemId = event.currentTarget.closest(\"[data-item-id]\").dataset.itemId;\n    const item = this.itemWithSpellsItem.itemSpellItemMap.get(itemId);\n    if (item.isEmbedded) return item.sheet.render(true);\n    // pop up a formapp to configure this item's overrides\n    return new ItemsWithSpells5eItemSpellOverrides(this.itemWithSpellsItem, itemId).render(true);\n  }\n\n  /**\n   * Synchronous part of the render which calls the asynchronous `renderHeavy`\n   * This allows for less delay during the update -> renderItemSheet -> set tab cycle\n   */\n  renderLite() {\n    // Update the nav menu\n    const div = document.createElement(\"DIV\");\n    div.innerHTML = `<a class=\"item\" data-tab=\"spells\">${game.i18n.localize(\"TYPES.Item.spellPl\")}</a>`;\n    const tabs = this.sheetHtml.querySelector(\".tabs[data-group=primary]\");\n    if (!tabs) return;\n    tabs.appendChild(div.firstElementChild);\n\n    // Create the tab\n    const sheetBody = this.sheetHtml.querySelector(\".sheet-body\");\n    div.innerHTML = \"<div class='tab spells flexcol' data-group='primary' data-tab='spells'></div>\";\n    const c = div.firstElementChild;\n    sheetBody.appendChild(c);\n    this.renderHeavy(c);\n  }\n\n  /**\n   * Heavy lifting part of the spells tab rendering which involves getting the spells and painting them.\n   * @param {HTMLElement} spellsTab\n   */\n  async renderHeavy(spellsTab) {\n    // Add the list to the tab\n    const div = document.createElement(\"DIV\");\n    div.innerHTML = await this._renderSpellsList();\n    const c = div.firstElementChild;\n    spellsTab.appendChild(c);\n\n    // Activate Listeners for this ui.\n    c.querySelectorAll(\".item-name\").forEach(n => n.addEventListener(\"click\", this._handleItemClick.bind(this)));\n    c.querySelectorAll(\".item-delete\").forEach(n => n.addEventListener(\"click\", this._handleItemDeleteClick.bind(this)));\n    c.querySelectorAll(\".item-destroy\").forEach(n => n.addEventListener(\"click\", this._handleItemDestroyClick.bind(this)));\n    c.querySelectorAll(\".configure-overrides\").forEach(n => n.addEventListener(\"click\", this._handleItemEditClick.bind(this)));\n\n    // Register a DragDrop handler for adding new spells to this item\n    const dragDrop = {\n      dragSelector: \".item\",\n      dropSelector: \".items-with-spells-tab\",\n      permissions: {drop: () => this.app.isEditable && !this.item.isEmbedded},\n      callbacks: {drop: this._dragEnd},\n    };\n    this.app.element[0].querySelector(dragDrop.dropSelector).addEventListener(\"drop\", dragDrop.callbacks.drop.bind(this));\n  }\n}\n","import {ItemsWithSpells5e as IWS} from './defaults.js';\n\n// the item types that can NEVER have spells in them.\nexport const EXCLUDED_TYPES = [\n  \"class\",\n  \"subclass\",\n  \"background\",\n  \"race\",\n  \"lineage\",\n  \"spell\",\n  \"base\",\n  \"container\",\n  \"backpack\"\n];\n\nexport function _registerSettings() {\n  const TYPES = Item.TYPES.filter(t => !EXCLUDED_TYPES.includes(t));\n\n  for (const type of TYPES) {\n    game.settings.register(IWS.MODULE_ID, `isIncludedItemType${type.titleCase()}`, {\n      scope: \"world\",\n      config: false,\n      type: Boolean,\n      default: true,\n      requiresReload: true\n    });\n  }\n\n  game.settings.register(IWS.MODULE_ID, \"sortOrder\", {\n    name: \"IWS.SETTINGS.SORT_ORDER.NAME\",\n    hint: \"IWS.SETTINGS.SORT_ORDER.HINT\",\n    scope: \"world\",\n    config: true,\n    type: Boolean,\n    default: false,\n    requiresReload: false\n  });\n\n  game.settings.registerMenu(IWS.MODULE_ID, \"itemTypeExclusion\", {\n    name: \"IWS.SETTINGS.ITEM_EXCLUSION.NAME\",\n    hint: \"IWS.SETTINGS.ITEM_EXCLUSION.HINT\",\n    scope: \"world\",\n    config: true,\n    type: IWS_TypeSettings,\n    label: \"IWS.SETTINGS.ITEM_EXCLUSION.NAME\",\n    restricted: true\n  });\n\n  game.settings.register(IWS.MODULE_ID, \"excludeUnequipped\", {\n    name: \"IWS.SETTINGS.EXCLUDE_UNEQUIPPED.NAME\",\n    hint: \"IWS.SETTINGS.EXCLUDE_UNEQUIPPED.HINT\",\n    scope: \"world\",\n    config: true,\n    type: Boolean,\n    default: true,\n    requiresReload: false\n  });\n}\n\nclass IWS_TypeSettings extends FormApplication {\n\n  get id() {\n    return `${IWS.MODULE_ID}-item-type-exclusion-menu`;\n  }\n\n  get title() {\n    return game.i18n.localize(\"IWS.SETTINGS.ITEM_EXCLUSION.TITLE\");\n  }\n\n  get template() {\n    return \"modules/items-with-spells-5e/templates/settingsMenu.hbs\";\n  }\n\n  async getData() {\n    const TYPES = Item.TYPES.filter(t => !EXCLUDED_TYPES.includes(t));\n    const data = await super.getData();\n    data.types = [];\n    for (const type of TYPES) {\n      const label = type.titleCase();\n      data.types.push({\n        checked: game.settings.get(IWS.MODULE_ID, `isIncludedItemType${label}`),\n        value: type,\n        label\n      });\n    }\n    return data;\n  }\n\n  async _updateObject(event, formData) {\n    Object.entries(formData).forEach(([type, bool]) => {\n      game.settings.set(IWS.MODULE_ID, `isIncludedItemType${type.titleCase()}`, bool);\n    });\n  }\n}\n","import {ItemsWithSpells5e as IWS} from '../classes/defaults.js';\r\nimport {ItemsWithSpells5eItem as IWSitem} from '../classes/item.js';\r\nimport {EXCLUDED_TYPES} from '../classes/settings.mjs';\r\n\r\nlet ItemsWithSpellsActionHandlerExtender = null\r\n\r\nexport class ItemsWithSpells5eExtendHUD {\r\n  static init() {\r\n    // only if both TAH Core and DnD5e modules are installed and active\r\n    if (!game.modules.get('token-action-hud-core')?.active || !game.modules.get('token-action-hud-dnd5e')?.active || !foundry.utils.isNewerVersion(game.modules.get('token-action-hud-dnd5e')?.version, '1.5.6')) return\r\n\r\n    // Create the parent group\r\n    Hooks.once(\"tokenActionHudCoreRegisterDefaults\", async (defaults) => {\r\n      const name = \"Items with Spells\"\r\n      const spellsLayout = defaults.layout.find(obj => obj.id === 'spells')\r\n      const newGroup = {\r\n        id: IWS.MODULE_ID,\r\n        name,\r\n        listName: `Group: ${name}`,\r\n        type: 'system',\r\n        nestId: `spells_${IWS.MODULE_ID}`\r\n      }\r\n      // Add the group\r\n      defaults.groups.push(newGroup)\r\n      // Make it visible at the top of the Spells tab by default\r\n      spellsLayout.groups.unshift(newGroup)\r\n    })\r\n\r\n    // Extend the class for making a sub-group per item and adding their spells to it\r\n    Hooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\r\n      ItemsWithSpellsActionHandlerExtender = class ItemsWithSpellsActionHandlerExtender extends coreModule.api.ActionHandlerExtender {\r\n\r\n        constructor(actionHandler) {\r\n          super();\r\n          this.actionHandler = actionHandler\r\n          this.actor = null\r\n          this.iwsExcludeUnequipped = null\r\n        }\r\n\r\n        /**\r\n         * Extend the action list\r\n         * @override\r\n         */\r\n        async extendActionHandler () {\r\n          this.actor = this.actionHandler.actor\r\n          if (!this.actor) return\r\n\r\n          this.iwsExcludeUnequipped = game.settings.get(IWS.MODULE_ID, \"excludeUnequipped\")\r\n\r\n          const parentGroupData = {\r\n              id: IWS.MODULE_ID,\r\n              type: 'system'\r\n          }\r\n\r\n          // iterate over all the items of this actor\r\n          for (const [key, item] of this.actor.items.entries()) {\r\n\r\n            // skip excluded item types\r\n            if ( EXCLUDED_TYPES.includes(item.type) ) continue\r\n\r\n            // skip if item's spells aren't usable\r\n            const itemUsable = IWS.isUsableItem(item)\r\n            if ( !itemUsable ) continue\r\n\r\n            // get spells of item\r\n            const actionData = await IWSitem.getItemSpells(item, true, this.actor.items)\r\n            if ( !actionData ) continue\r\n\r\n            // Create a group for this item\r\n            const info1 = {}\r\n            const uses = item?.system?.uses\r\n            if (uses?.per && (uses.value > 0 || uses.max > 0)) {\r\n              const per = coreModule.api.Utils.i18n('DND5E.per')\r\n              const period = CONFIG.DND5E.limitedUsePeriods[uses.per]?.label ?? uses.per\r\n              const perPeriod = uses.per === 'charges' ? period : `${per} ${period}`\r\n              info1.text = `${uses.value ?? '0'}${uses.max > 0 ? `/${uses.max}` : ''}`\r\n              info1.title = `${item.name}: ${info1.text} ${perPeriod}`\r\n            }\r\n            const groupData = {\r\n                id: `${IWS.MODULE_ID}_${item.id}`,\r\n                name: item.name,\r\n                type: 'system-derived',\r\n                info1,\r\n                defaultSelected: true,\r\n                settings: { sort: true }\r\n            }\r\n\r\n            // Add group to HUD\r\n            this.actionHandler.addGroup(groupData, parentGroupData)\r\n\r\n            // Add actions to the group, using the TAH DnD5e Build Actions\r\n            const actionType = 'spell'\r\n            const data = { groupData, actionData, actionType }\r\n            console.log('data: ', data)\r\n            await this.actionHandler.buildActions(data)\r\n          }\r\n        }\r\n      }\r\n    })\r\n\r\n    // Add the new class to TAH workflow\r\n    Hooks.once(\"tokenActionHudCoreAddActionHandlerExtenders\", async (actionHandler) => {\r\n      actionHandler.addActionHandlerExtender(new ItemsWithSpellsActionHandlerExtender(actionHandler))\r\n    })\r\n\r\n  }\r\n}\r\n","\nimport {ItemsWithSpells5e} from './classes/defaults.js';\nimport {ItemsWithSpells5eActorSheet} from './classes/actor-sheet.js';\nimport {ItemsWithSpells5eActor} from './classes/actor.js';\nimport {ItemsWithSpells5eItem} from './classes/item-sheet.js';\nimport {ItemsWithSpells5eItemSheet} from './classes/item-sheet.js';\nimport {_registerSettings} from './classes/settings.mjs';\nimport {ItemsWithSpells5eExtendHUD} from './extensions/token-action-hud-dnd5e.js';\n\nHooks.once(\"setup\", _registerSettings);\nHooks.once(\"init\", ItemsWithSpells5eActor.init);\nHooks.once(\"init\", ItemsWithSpells5eActorSheet.init);\nHooks.once(\"init\", ItemsWithSpells5e.init);\nHooks.once(\"init\", ItemsWithSpells5eItemSheet.init);\nHooks.once(\"init\", ItemsWithSpells5eExtendHUD.init);\nHooks.once(\"ready\", async () => {\n  const module = game.modules.get(ItemsWithSpells5e.MODULE_ID);\n  module.api = {\n    isIwsItem: ItemsWithSpells5e.isIwsItem,\n    isIwsSpell: ItemsWithSpells5e.isIwsSpell,\n    getItemSpells: ItemsWithSpells5eItem.getItemSpells,\n    getSpellParentId: ItemsWithSpells5e.getSpellParentId,\n    getSpellParentItem: ItemsWithSpells5e.getSpellParentItem,\n    isIncludedItemType: ItemsWithSpells5e.isIncludedItemType,\n    isUsableItem: ItemsWithSpells5e.isUsableItem\n  }\n});"],"names":["ItemsWithSpells5e","static","itemSpells","parentItem","spellsTab","MODULE_ID","overrides","init","preloadTemplates","dnd5e","utils","registerHandlebarsHelpers","loadTemplates","TEMPLATES","isIwsItem","item","getFlag","FLAGS","isIwsSpell","spell","getSpellParentId","getSpellParentItem","embeddedOnly","providedItems","isEmbedded","parentId","items","actor","parentIdLast","split","pop","get","fromUuid","isIncludedItemType","itemType","include","game","settings","titleCase","isUsableItem","system","identified","equipped","user","isGM","foundry","isNewerVersion","version","attunementRequired","attunement","attuned","CONFIG","DND5E","attunementTypes","REQUIRED","ItemsWithSpells5eActorSheet","id","IWS","fn","prepareItemSpellbook","forEach","a","libWrapper","register","wrapped","data","spells","order","nonItemSpells","spellsPerItem","Map","this","some","uuid","includes","set","push","spellbook","filter","fl","length","type","iws","iwsSpells","section","uses","label","name","usesSlots","canCreate","canPrepare","value","slots","max","override","dataset","prop","createSection","sort","b","ItemsWithSpells5eActor","Hooks","on","handleCreateItem","handleDeleteItem","itemDeleted","options","userId","parent","Actor","spellIds","reduce","acc","flag","optionOverride","itemsWithSpells5e","alsoDeleteChildSpells","autoConfirm","Dialog","confirm","title","i18n","localize","content","deleteEmbeddedDocuments","itemCreated","spellUuids","spellData","Promise","all","map","d","_createSpellData","s","ids","createEmbeddedDocuments","setFlag","changes","attackBonus","ability","usesMax","rollData","getRollData","deterministic","simplifyBonus","consume","amount","target","fromCompendium","mergeData","tidy5eSectionFlag","flags","mergeObject","ItemsWithSpells5eItemSpellOverrides","FormApplication","constructor","itemWithSpellsItem","itemSpellId","itemSpellFlagData","itemSpellFlagMap","super","itemSpellItem","itemSpellItemMap","defaultOptions","classes","template","width","closeOnSubmit","submitOnChange","height","getData","hasAttack","hasSave","save","object","config","limitedUsePeriods","abilities","spellLevels","saveScaling","flat","isFlatDC","scaling","hasUses","hasLimitedUses","per","_updateObject","event","formData","formDataExpanded","expandObject","updateItemSpellOverrides","ui","notifications","warn","SubmitEvent","close","render","ItemsWithSpells5eItem","_itemSpellFlagMap","_itemSpellItems","_getItemSpellFlagMap","itemSpellList","_getItemSpellItems","refresh","_getChildItem","original","Item","implementation","img","description","_id","temporary","FakeEmptySpell","update","_getFlagFixObject","getProperty","childItem","toObject","keepId","updateSource","itemMap","async","itemSpellFlag","providedUuid","sourceIdFlag","addSpellToItem","fullItemData","error","adjustedItemData","newItem","property","removeSpellFromItem","itemId","alsoDeleteEmbeddedSpell","itemToDelete","uuidToRemove","newItemSpells","delete","spellItem","fromUuidSync","unsetFlag","itemSpellFlagsToUpdate","newItemSpellsFlagValue","values","ItemsWithSpells5eItemSheet","instances","instance","_shouldOpenSpellsTab","getItemSpells","ItemsWithSpellsItem","itemIds","app","html","sheetHtml","modules","api","isTidy5eItemSheet","appId","renderLite","_tabs","activate","newInstance","once","myTab","models","HtmlTab","tabId","enabled","onRender","params","element","renderHeavy","tabContentsElement","registerItemTab","autoHeight","_renderSpellsList","itemSpellsArray","renderTemplate","isOwner","concealDetails","_dragEnd","isEditable","TextEditor","getDragEventData","_handleItemClick","currentTarget","closest","sheet","editable","_handleItemDeleteClick","_handleItemDestroyClick","_handleItemEditClick","div","document","createElement","innerHTML","tabs","querySelector","appendChild","firstElementChild","sheetBody","c","querySelectorAll","n","addEventListener","bind","dragDrop","dragSelector","dropSelector","permissions","drop","callbacks","EXCLUDED_TYPES","IWS_TypeSettings","TYPES","t","types","checked","Object","entries","bool","ItemsWithSpellsActionHandlerExtender","ItemsWithSpells5eExtendHUD","active","defaults","spellsLayout","layout","find","obj","newGroup","listName","nestId","groups","unshift","coreModule","ActionHandlerExtender","actionHandler","iwsExcludeUnequipped","extendActionHandler","parentGroupData","key","actionData","IWSitem","info1","Utils","period","perPeriod","text","groupData","defaultSelected","addGroup","actionType","console","log","buildActions","addActionHandlerExtender","_registerSettings","scope","Boolean","default","requiresReload","hint","registerMenu","restricted"],"mappings":"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"}